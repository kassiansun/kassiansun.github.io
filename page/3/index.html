<!doctype html><html lang=en dir=auto><head><meta name=generator content="Hugo 0.134.2"><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kassian Sun</title>
<meta name=description content><meta name=author content><link rel=canonical href=https://blog.kassiansun.com/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.kassiansun.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.kassiansun.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.kassiansun.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.kassiansun.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.kassiansun.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://blog.kassiansun.com/index.xml><link rel=alternate hreflang=en href=https://blog.kassiansun.com/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-0NC5Q6H2ZC"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0NC5Q6H2ZC")}</script><meta property="og:title" content="Kassian Sun"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://blog.kassiansun.com/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kassian Sun"><meta name=twitter:description content><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"Kassian Sun","url":"https://blog.kassiansun.com/","description":"","thumbnailUrl":"https://blog.kassiansun.com/favicon.ico","sameAs":[]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.kassiansun.com/ accesskey=h title="Kassian Sun (Alt + H)">Kassian Sun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.kassiansun.com/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Travesal Through The Go Compiler, Part 5</h2></header><div class=entry-content><p>irgen.generate Check each file’s pragma list and DeclList. Generate ir.Decl for type declarations. Generate ir.Decl for other declarations. Process later functions, this step is for the same purpose as type check. Type-check CallExpr again. Check missing function bodies. Build generic instantiations. It scans calls and generated needed methods. Remove all generic Decl’s. After irgen.generate, g.target.Decls will be the final Decl’s to generate.
enqueueFunc and compileFunctions This step is the compile step of cmd/compile, it happens after type checking and IR generation.
...</p></div><footer class=entry-footer><span title='2022-09-19 10:54:34 +0800 +0800'>September 19, 2022</span></footer><a class=entry-link aria-label="post link to Travesal Through The Go Compiler, Part 5" href=https://blog.kassiansun.com/posts/go-source-code-part-5/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Travesal Through The Go Compiler, Part 4</h2></header><div class=entry-content><p>noder.LoadPackage Parsing noder.LoadPackage will call syntax.Parse to generate the syntax tree of all package files.
Initialize a compile/internal/syntax.scanner Advance scanner to the next token. Start parsing. Check the package declaration first, and take the package name from the parsed pragma. Note that the parser is expecting a ; token, but this is automatically generated at the scanner, so users don’t have to write the ;. And parsing errors will not always abort the parser loop. Parse top-level declarations: const type var func Each type has its function to parse the whole syntax tree. Type Checking After syntax.Parse, check2 is called to do the IR generation.
...</p></div><footer class=entry-footer><span title='2022-09-18 14:09:58 +0800 +0800'>September 18, 2022</span></footer><a class=entry-link aria-label="post link to Travesal Through The Go Compiler, Part 4" href=https://blog.kassiansun.com/posts/go-source-code-part-4/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Travesal Through The Go Compiler, Part 3</h2></header><div class=entry-content><p>BuildToolchain BuildToolchain is initialized as noToolchain{} by default, then it’s set dynamically to gccgo or gc. Both implementations are wrappers around the binary toolchains installed on the machine. For gc, the delegations are as follows:
BuildToolchain.gc - base.Tool("compile") BuildToolchain.cc - base.Tool("cgo"). Actually cgo has been executed before the compile and cfiles has been cleared, so BuildToolchain.cc should never be called and it always returns an error. BuildToolchain.asm - base.Tool("asm") BuildToolchain.pack - base.Tool("pack") BuildToolchain.ld - base.Tool("link") cmd/compile aka base.Tool(“compile”) Entry point: internal/gc.Main It’s a standalone binary which means all packages path assumes a relative path to go/src/cmd/compile. gc.Main will get an archInit function as the parameter, this function populates the ssagen.ArchInfo which contains necessary architecture information.
...</p></div><footer class=entry-footer><span title='2022-09-17 09:29:52 +0800 +0800'>September 17, 2022</span></footer><a class=entry-link aria-label="post link to Travesal Through The Go Compiler, Part 3" href=https://blog.kassiansun.com/posts/go-source-code-part-3/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Travesal Through The Go Compiler, Part 2</h2></header><div class=entry-content><p>Builder.build Builder.build generate an archive for a single package.
Builder.build gets building information from two sources: internal/cfg package. It contains some global variables saving build flags. load.Package. It contains information for the current building package. Builder.build will build a need flag, finish the step and uncheck the finished bits one by one. Set up caching information by action, its package, and package’s target. Set up objects output directory. Setup cgo cache & vet cache. Set up building target directory. Set up non-Go files overlay. This step is to copy the non-Go files to the object directory. Preprocess coverage files and replace the file path of original *.go files. It runs go tool cover -mode=b.coverMode -var="varName" -o dst.go src.go to generate the coverage files. Build cgo files. After the build, the cfiles will be cleared and generated go files will be added to gofiles Cache all source files. It’s all *.go files now Generate import configuration and package dependencies information. Generate embedded files configuration. Run BuildToolchain.gc. This is the actual go build stage. Run BuildToolchain.cc. This is the actual cgo build stage. Run BuildToolchain.asm. This is the actual *.s build stage. Run BuildToolchain.pack. This will generate the object archive (*.a). Update the BuildID accordingly. Builder.link Builder.link links a package and generates the final binary. It’s very simple compared with the build stage.
...</p></div><footer class=entry-footer><span title='2022-09-16 15:16:23 +0800 +0800'>September 16, 2022</span></footer><a class=entry-link aria-label="post link to Travesal Through The Go Compiler, Part 2" href=https://blog.kassiansun.com/posts/go-source-code-part-2/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Traversal Through The Go Compiler, Part 1</h2></header><div class=entry-content><p>Set Up the Environment vim-go doesn’t support travesal through the go source code, so I switch to vscode and it works out of box (with Go plugin && gopls installed).
Start Point (go run) File: src/cmd/go/main.go Declaration: run.CmdRun Function: run.runRun Key data structures: build.Context work.Builder load.Package work.Action The runRun function will go through several stages:
Check shouldUseOutsideModuleMode. This procedure is used by go run cmd@version work.BuildInit. This will setup the build context: Initialize modload module. It will check go module flags and set up the flags, no actual module download. instrumentInit and buildModeInit, and update the default build.Context accordingly. Get a work.Builder. work.NewBuilder will check the environment and make sure it’s ready to do the actual build. Inits a load.Package from all *.go files passed to go run. load.Package has a public struct for definitions, and an internal struct for running state. Setup builder.LinkAction. LinkAction will call cacheAction (for looking up action cache, not build cache), CompileAction, and installAction (not for go run). work.Action is a DAG, the action cache depends on mode and package info. Initialize a work.Action, use the link action initialized at the above stage as dependencies. Build the work.Action with builder. Build Stage (Builder.Do) Set up the cache trim. There’s a trim.txt inside go-build cache folder, it’s used to track the timestamp of last trim action. Build the action list, visit the DAG as “depth-first post-order travelsal”. The priority will set by the list order, which means deepest will run first. writeActionGraph. Internal feature, this will dump the DAG as JSON. Set up triggers. Triggers are the inverse of dependencies, which means when the dependency ready, it will trigger its root instead of its dependencies. The handle function will do the actual jobs. Actions are run in parallel, the actual job is defined by action.Func. After actions done, update the global state. There’s a lock to make sure there’s no data races. If all dependencies finished, push the action node to ready queue and signal the readySema. Ready queue are protected with the same global state lock. Run all actions from the DAG in parallel. What’s Next Travesal through the action.Func definitions:
...</p></div><footer class=entry-footer><span title='2022-09-15 08:48:31 +0800 +0800'>September 15, 2022</span></footer><a class=entry-link aria-label="post link to Traversal Through The Go Compiler, Part 1" href=https://blog.kassiansun.com/posts/go-source-code-part-1/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Why You Shouldn't Save Sessions in Redis Anymore</h2></header><div class=entry-content><p>Sessions are important Security is an important factor of a reliable system, and from a user’s perspective, sessions are where the secure process starts. Sessions are no longer a volatile string saved in Redis/memcached, but a key to everything owned by users. Expiration time, login IP, login device, and many other properties of sessions should be tracked and managed properly.
The importance of sessions makes the cache an improper choice: the nature of caching means you shouldn’t put anything important in it. Saving a business-related data in cache will make the cache a critical path in your business logic, make the logic fragile and increase the SLA number of cache systems, then make it more expensive to operate the caching system.
...</p></div><footer class=entry-footer><span title='2022-03-12 17:43:32 +0800 +0800'>March 12, 2022</span></footer><a class=entry-link aria-label="post link to Why You Shouldn't Save Sessions in Redis Anymore" href=https://blog.kassiansun.com/posts/why-dont-use-session-in-cache/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>A Glide Helper for Jetpack Compose</h2></header><div class=entry-content><p>The design of Jetpack Compose makes an important assumption on the rendering process: the developer should not assume whether or not a composable will render, and how it will render. So any code inside a composable can be called by [0-N] times. That’s why Compose introduced several helpers to control the code execution of composable (instead of controlling the rendering process):
remember makes a state persisted among recomposition. The state will be destroyed if the composable is removed from Composition. LaunchedEffect controls how suspend functions will be executed and canceled. It has a key to determine whether to re-execute the code. LocalContext.current will get the current context of Composable. Most Android libraries will detect the context lifecycle. The Implementation import android.graphics.Bitmap import android.graphics.drawable.Drawable import android.net.Uri import android.util.Log import androidx.compose.runtime.* import androidx.compose.ui.platform.LocalContext import com.bumptech.glide.Glide import com.bumptech.glide.request.target.CustomTarget import com.bumptech.glide.request.transition.Transition @Composable fun loadPicture(picUri: Uri): MutableState&lt;Bitmap?> { // the persisted state of helper val bitmapState: MutableState&lt;Bitmap?> = remember { mutableStateOf(null) } // current context val context = LocalContext.current // glide execution control LaunchedEffect(picUri) { Log.d("utils", "loading image: $picUri") // Thanks for the original idea from https://www.youtube.com/channel/UCoNZZLhPuuRteu02rh7bzsw // Code copied from https://www.youtube.com/watch?v=ktOWiLx83bQ Glide.with(context).asBitmap().load(picUri) .into(object : CustomTarget&lt;Bitmap>() { override fun onResourceReady( resource: Bitmap, transition: Transition&lt;in Bitmap>? ) { Log.d("utils", "setting bitmap") bitmapState.value = resource } override fun onLoadCleared(placeholder: Drawable?) { bitmapState.value = null } }) } return bitmapState }</p></div><footer class=entry-footer><span title='2022-01-03 10:31:26 +0800 +0800'>January 3, 2022</span></footer><a class=entry-link aria-label="post link to A Glide Helper for Jetpack Compose" href=https://blog.kassiansun.com/posts/jetpack-glide-helper/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Introducing Tailwind CSS to My React Project</h2></header><div class=entry-content><p>Why Tailwind CSS is good? Recently, I picked up the frontend project at the current company. Compared with traditional MVC-style native development, the web development feels more natural to me: declarative, MVVM, state flow, etc. But if we compare the react/vue with SwiftUI/Jetpack Compose, there’s a key pain point: styling. With SwiftUI/Jetpack Compose, the styling is part of view declaration, which makes it easy to read and maintain.
Traditionally, CSS & HTML are separated from each other, and there’re several practices to organize them. All of these practices have some defects, more or less. In my opinion, all of these issues come from the separation of CSS and HTML. The author of Tailwind CSS wrote a great blog on this.
...</p></div><footer class=entry-footer><span title='2021-12-25 11:34:15 +0800 +0800'>December 25, 2021</span></footer><a class=entry-link aria-label="post link to Introducing Tailwind CSS to My React Project" href=https://blog.kassiansun.com/posts/introduce-tailwind-to-react/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Fix GCC 11 Missing Headers on Mac OS Monterey</h2></header><div class=entry-content><p>Encountered this issue trying to compile a simple “Hello World” program with gcc-11 from homebrew. The compiler complained about fatal error: _stdio.h: No such file or directory. After some investigation, this was caused by wrong building configuration for gcc:
$ gcc -v Using built-in specs. COLLECT_GCC=gcc-11 COLLECT_LTO_WRAPPER=/opt/homebrew/Cellar/gcc/11.2.0_3/libexec/gcc/aarch64-apple-darwin21/11/lto-wrapper Target: aarch64-apple-darwin21 Configured with: ../configure --prefix=/opt/homebrew/Cellar/gcc/11.2.0_3 --libdir=/opt/homebrew/Cellar/gcc/11.2.0_3/lib/gcc/11 --disable-nls --enable-checking=release --with-gcc-major-version-only --enable-languages=c,c++,objc,obj-c++,fortran --program-suffix=-11 --with-gmp=/opt/homebrew/opt/gmp --with-mpfr=/opt/homebrew/opt/mpfr --with-mpc=/opt/homebrew/opt/libmpc --with-isl=/opt/homebrew/opt/isl --with-zstd=/opt/homebrew/opt/zstd --with-pkgversion='Homebrew GCC 11.2.0_3' --with-bugurl=https://github.com/Homebrew/homebrew-core/issues --build=aarch64-apple-darwin21 --with-system-zlib --disable-multilib --with-native-system-header-dir=/usr/include --with-sysroot=/Library/Developer/CommandLineTools/SDKs/MacOSX12.sdk Thread model: posix Supported LTO compression algorithms: zlib zstd gcc version 11.2.0 (Homebrew GCC 11.2.0_3) The gcc from homebrew is assuming --with-sysroot=/Library/Developer/CommandLineTools/SDKs/MacOSX12.sdk, but it doesn’t exists on Mac OS Monterey. Instead the path is /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk. As we now know the root cause of this issue, fixing it will be easy:
...</p></div><footer class=entry-footer><span title='2021-12-08 19:10:30 +0800 +0800'>December 8, 2021</span></footer><a class=entry-link aria-label="post link to Fix GCC 11 Missing Headers on Mac OS Monterey" href=https://blog.kassiansun.com/posts/gcc-missing-headers/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent>Quick Start Guide with create-react-app (TypeScript + Eslint + Prettier)</h2></header><div class=entry-content><p>Why use create-react-app Originally I was using a manually written webpack script to build my react project. The reason was to reduce the length of package-lock.json. But as I’m diving deeper into the frontend ecosystem, it doesn’t look like a good choice to wait for frontend guys fixing the dependency hell. So instead of waiting for a neat solution, I need to find a quick solution.
As part of the lessons I learned from handwriting webpack scripts, it’s hard to build a complete and reusable scaffold to build a React.js + TypeScript + ESLint project. create-react-app is good enough with only minimal extra configurations. This blog is mainly a note on how to quickly start another project later.
...</p></div><footer class=entry-footer><span title='2021-12-02 12:13:43 +0800 +0800'>December 2, 2021</span></footer><a class=entry-link aria-label="post link to Quick Start Guide with create-react-app (TypeScript + Eslint + Prettier)" href=https://blog.kassiansun.com/posts/create-react-app-typescript-eslint/></a></article><footer class=page-footer><nav class=pagination><a class=prev href=https://blog.kassiansun.com/page/2/>«&nbsp;Prev&nbsp;
</a><a class=next href=https://blog.kassiansun.com/page/4/>Next&nbsp;&nbsp;»</a></nav></footer></main><footer class=footer><span>&copy; 2024 <a href=https://blog.kassiansun.com/>Kassian Sun</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>