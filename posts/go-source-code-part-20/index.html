<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Go Runtime Implementations: Defer, Panic and Recover | Kassian Sun</title>
<meta name=keywords content><meta name=description content="Code Path: src/runtime/panic.go Ref: Defer, Panic, and Recover Defer Two methods of defer Copied from the comment:
The older way involves creating a defer record at the time that a defer statement is executing and adding it to a defer chain. This chain is inspected by the deferreturn call at all function exits in order to run the appropriate defer calls.
A cheaper way (which we call open-coded defers) is used for functions in which no defer statements occur in loops."><meta name=author content><link rel=canonical href=https://blog.kassiansun.com/posts/go-source-code-part-20/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.kassiansun.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.kassiansun.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.kassiansun.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.kassiansun.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.kassiansun.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.kassiansun.com/posts/go-source-code-part-20/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-E9FSQ1R0HV"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E9FSQ1R0HV")}</script><meta property="og:title" content="Go Runtime Implementations: Defer, Panic and Recover"><meta property="og:description" content="Code Path: src/runtime/panic.go Ref: Defer, Panic, and Recover Defer Two methods of defer Copied from the comment:
The older way involves creating a defer record at the time that a defer statement is executing and adding it to a defer chain. This chain is inspected by the deferreturn call at all function exits in order to run the appropriate defer calls.
A cheaper way (which we call open-coded defers) is used for functions in which no defer statements occur in loops."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kassiansun.com/posts/go-source-code-part-20/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-25T14:18:47+08:00"><meta property="article:modified_time" content="2023-06-25T14:18:47+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go Runtime Implementations: Defer, Panic and Recover"><meta name=twitter:description content="Code Path: src/runtime/panic.go Ref: Defer, Panic, and Recover Defer Two methods of defer Copied from the comment:
The older way involves creating a defer record at the time that a defer statement is executing and adding it to a defer chain. This chain is inspected by the deferreturn call at all function exits in order to run the appropriate defer calls.
A cheaper way (which we call open-coded defers) is used for functions in which no defer statements occur in loops."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.kassiansun.com/posts/"},{"@type":"ListItem","position":2,"name":"Go Runtime Implementations: Defer, Panic and Recover","item":"https://blog.kassiansun.com/posts/go-source-code-part-20/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Go Runtime Implementations: Defer, Panic and Recover","name":"Go Runtime Implementations: Defer, Panic and Recover","description":"Code Path: src/runtime/panic.go Ref: Defer, Panic, and Recover Defer Two methods of defer Copied from the comment:\nThe older way involves creating a defer record at the time that a defer statement is executing and adding it to a defer chain. This chain is inspected by the deferreturn call at all function exits in order to run the appropriate defer calls.\nA cheaper way (which we call open-coded defers) is used for functions in which no defer statements occur in loops.","keywords":[],"articleBody":" Code Path: src/runtime/panic.go Ref: Defer, Panic, and Recover Defer Two methods of defer Copied from the comment:\nThe older way involves creating a defer record at the time that a defer statement is executing and adding it to a defer chain. This chain is inspected by the deferreturn call at all function exits in order to run the appropriate defer calls.\nA cheaper way (which we call open-coded defers) is used for functions in which no defer statements occur in loops. In that case, we simply store the defer function/arg information into specific stack slots at the point of each defer statement, as well as setting a bit in a bitmask. At each function exit, we add inline code to directly make the appropriate defer calls based on the bitmask and fn/arg information stored on the stack. During panic/Goexit processing, the appropriate defer calls are made using extra funcdata info that indicates the exact stack slots that contain the bitmask and defer fn/args.\nDefer implementations There’re three ways of defer:\ndeferproc deferprocStack inline defer deferproc and deferprocStack will update the list gp._defer.\nGoexit Goexit calls all gp._defer, and then calls goexit1() to release the resources.\nPanic Runtime panics goPanic* Copied from the comment:\nSince panic{Index,Slice,shift} are never called directly, and since the runtime package should never have an out of bounds slice or array reference or negative shift, if we see those functions called from the runtime package we turn the panic into a throw. That will dump the entire runtime stack for easier debugging.\ngopanic Checks whether it’s panicking on system stack, during mallocing, with preempt off, or holding lock. Add itself to the panic list gp._panic addOneOpenDeferFrame Handle the loop of defer and panic The most important thing is that panic overwrites previous panic gorecover Copied from the comment:\nMust be in a function running as part of a deferred call during the panic.\nMust be called from the topmost function of the call\n","wordCount":"326","inLanguage":"en","datePublished":"2023-06-25T14:18:47+08:00","dateModified":"2023-06-25T14:18:47+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.kassiansun.com/posts/go-source-code-part-20/"},"publisher":{"@type":"Organization","name":"Kassian Sun","logo":{"@type":"ImageObject","url":"https://blog.kassiansun.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.kassiansun.com/ accesskey=h title="Kassian Sun (Alt + H)">Kassian Sun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.kassiansun.com/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Go Runtime Implementations: Defer, Panic and Recover</h1><div class=post-meta><span title='2023-06-25 14:18:47 +0800 +0800'>June 25, 2023</span></div></header><div class=post-content><ul><li>Code Path: <code>src/runtime/panic.go</code></li><li>Ref: <a href=https://go.dev/blog/defer-panic-and-recover>Defer, Panic, and Recover</a></li></ul><h1 id=defer>Defer<a hidden class=anchor aria-hidden=true href=#defer>#</a></h1><h2 id=two-methods-of-defer>Two methods of <code>defer</code><a hidden class=anchor aria-hidden=true href=#two-methods-of-defer>#</a></h2><p>Copied from the comment:</p><blockquote><p>The older way involves creating a
defer record at the time that a defer statement is executing and adding it to a
defer chain. This chain is inspected by the deferreturn call at all function
exits in order to run the appropriate defer calls.</p></blockquote><blockquote><p>A cheaper way (which we call open-coded defers) is used for functions in which no defer statements occur in
loops. In that case, we simply store the defer function/arg information into
specific stack slots at the point of each defer statement, as well as setting a
bit in a bitmask. At each function exit, we add inline code to directly make
the appropriate defer calls based on the bitmask and fn/arg information stored
on the stack. During panic/Goexit processing, the appropriate defer calls are
made using extra funcdata info that indicates the exact stack slots that
contain the bitmask and defer fn/args.</p></blockquote><h2 id=defer-implementations>Defer implementations<a hidden class=anchor aria-hidden=true href=#defer-implementations>#</a></h2><p>There&rsquo;re three ways of defer:</p><ul><li>deferproc</li><li>deferprocStack</li><li>inline defer</li></ul><p><code>deferproc</code> and <code>deferprocStack</code> will update the list <code>gp._defer</code>.</p><h1 id=goexit>Goexit<a hidden class=anchor aria-hidden=true href=#goexit>#</a></h1><p><code>Goexit</code> calls all <code>gp._defer</code>, and then calls <code>goexit1()</code> to release the resources.</p><h1 id=panic>Panic<a hidden class=anchor aria-hidden=true href=#panic>#</a></h1><h2 id=runtime-panics-gopanic>Runtime panics <code>goPanic*</code><a hidden class=anchor aria-hidden=true href=#runtime-panics-gopanic>#</a></h2><p>Copied from the comment:</p><blockquote><p>Since panic{Index,Slice,shift} are never called directly, and
since the runtime package should never have an out of bounds slice
or array reference or negative shift, if we see those functions called from the
runtime package we turn the panic into a throw. That will dump the
entire runtime stack for easier debugging.</p></blockquote><h2 id=gopanic><code>gopanic</code><a hidden class=anchor aria-hidden=true href=#gopanic>#</a></h2><ul><li>Checks whether it&rsquo;s panicking on system stack, during mallocing, with preempt off, or holding lock.</li><li>Add itself to the panic list <code>gp._panic</code></li><li><code>addOneOpenDeferFrame</code></li><li>Handle the loop of <code>defer</code> and <code>panic</code><ul><li>The most important thing is that panic overwrites previous panic</li></ul></li></ul><h2 id=gorecover><code>gorecover</code><a hidden class=anchor aria-hidden=true href=#gorecover>#</a></h2><p>Copied from the comment:</p><blockquote><p>Must be in a function running as part of a deferred call during the panic.</p></blockquote><blockquote><p>Must be called from the topmost function of the call</p></blockquote></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.kassiansun.com/>Kassian Sun</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>