<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Redis Architecture | Kassian Sun</title><meta name=keywords content="redis"><meta name=description content="Start-Up Procedures spt_init: This procedure initializes the process&rsquo;s name and deep copy command-line arguments & environments. tzset. zmalloc_set_oom_handler init_genrand64 with timestamp and pid number. Code Path: mt19937-64.c crc64_init. Code Path: crc64.c umask dictSetHashFunctionSeed with a random 16-byte seed. Code Path: dict.c initServerConfig ACLInit. Code Path: acl.c moduleInitModulesSystem. Code Path: module.c connTypeInitialize. Code Path: connection.c initSentinelConfig and initSentinel if the server was started in sentinel mode. Code Path: sentinel.c Run redis_check_aof_main or redis_check_rdb_main and exit."><meta name=author content><link rel=canonical href=https://kassiansun.github.io/posts/redis-architecture/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://kassiansun.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kassiansun.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kassiansun.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://kassiansun.github.io/apple-touch-icon.png><link rel=mask-icon href=https://kassiansun.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-E9FSQ1R0HV"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E9FSQ1R0HV",{anonymize_ip:!1})}</script><meta property="og:title" content="Redis Architecture"><meta property="og:description" content="Start-Up Procedures spt_init: This procedure initializes the process&rsquo;s name and deep copy command-line arguments & environments. tzset. zmalloc_set_oom_handler init_genrand64 with timestamp and pid number. Code Path: mt19937-64.c crc64_init. Code Path: crc64.c umask dictSetHashFunctionSeed with a random 16-byte seed. Code Path: dict.c initServerConfig ACLInit. Code Path: acl.c moduleInitModulesSystem. Code Path: module.c connTypeInitialize. Code Path: connection.c initSentinelConfig and initSentinel if the server was started in sentinel mode. Code Path: sentinel.c Run redis_check_aof_main or redis_check_rdb_main and exit."><meta property="og:type" content="article"><meta property="og:url" content="https://kassiansun.github.io/posts/redis-architecture/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-10T15:21:10+08:00"><meta property="article:modified_time" content="2022-11-10T15:21:10+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Redis Architecture"><meta name=twitter:description content="Start-Up Procedures spt_init: This procedure initializes the process&rsquo;s name and deep copy command-line arguments & environments. tzset. zmalloc_set_oom_handler init_genrand64 with timestamp and pid number. Code Path: mt19937-64.c crc64_init. Code Path: crc64.c umask dictSetHashFunctionSeed with a random 16-byte seed. Code Path: dict.c initServerConfig ACLInit. Code Path: acl.c moduleInitModulesSystem. Code Path: module.c connTypeInitialize. Code Path: connection.c initSentinelConfig and initSentinel if the server was started in sentinel mode. Code Path: sentinel.c Run redis_check_aof_main or redis_check_rdb_main and exit."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kassiansun.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Redis Architecture","item":"https://kassiansun.github.io/posts/redis-architecture/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Redis Architecture","name":"Redis Architecture","description":"Start-Up Procedures spt_init: This procedure initializes the process\u0026rsquo;s name and deep copy command-line arguments \u0026amp; environments. tzset. zmalloc_set_oom_handler init_genrand64 with timestamp and pid number. Code Path: mt19937-64.c crc64_init. Code Path: crc64.c umask dictSetHashFunctionSeed with a random 16-byte seed. Code Path: dict.c initServerConfig ACLInit. Code Path: acl.c moduleInitModulesSystem. Code Path: module.c connTypeInitialize. Code Path: connection.c initSentinelConfig and initSentinel if the server was started in sentinel mode. Code Path: sentinel.c Run redis_check_aof_main or redis_check_rdb_main and exit.","keywords":["redis"],"articleBody":"Start-Up Procedures spt_init: This procedure initializes the process’s name and deep copy command-line arguments \u0026 environments. tzset. zmalloc_set_oom_handler init_genrand64 with timestamp and pid number. Code Path: mt19937-64.c crc64_init. Code Path: crc64.c umask dictSetHashFunctionSeed with a random 16-byte seed. Code Path: dict.c initServerConfig ACLInit. Code Path: acl.c moduleInitModulesSystem. Code Path: module.c connTypeInitialize. Code Path: connection.c initSentinelConfig and initSentinel if the server was started in sentinel mode. Code Path: sentinel.c Run redis_check_aof_main or redis_check_rdb_main and exit. Code Path: redis-check-aof.c, redis-check-rdb.c Parse command-line options and loadServerConfig. Code Path: config.c. sentinelCheckConfigFile if it’s in sentinel mode. Code Path: sentinel.c Check whether the server is supervised by upstart or systemd. daemonize if required. initServer. It initializes the global redisServer structure. createPidFile if required. redisSetProcTitle if required. checkTcpBacklogSettings. clusterInit if it’s in cluster mode. Code Path: cluster.c moduleLoadFromQueue. Code Path: module.c. ACLLoadUsersAtStartup, Code path: acl.c. initListeners. Redis supports multiple types of listeners, and each one has its own accept handling logic. The listeners will be registered by aeCreateFileEvent clusterInitListeners if it’s in cluster mode. Code Path: cluster.c bioInit initializes the redis’s background I/O. Code Path: bio.c initThreadedIO initializes the threaded I/O. Code Path: networking.c set_jemalloc_bg_thread. If it’s not sentinel mode: aofLoadManifestFromDisk. Code Path: aof.c loadDataFromDisk. It will either load the AOF file with loadAppendOnlyFiles, or load the RDB file with rdbLoad and initialize the replication backlog with createReplicationBacklog. RDB Code Path: rdb.c aofOpenIfNeededOnServerStart to open the AOF file on disk. Code Path: aof.c aofDelHistoryFiles to clear the history_aof_list. Code Path: aof.c verifyClusterConfigWithData check the cluster slots. Note that cluster mode only allows data in db 0. Code Path: cluster.c Else, do sentinelIsRunning. redisSetCpuAffinity setOOMScoreAdj will update the value in /proc/self/oom_score_adj aeMain starts the event loop. aeDeleteEventLoop after the event loop is finished. Code Path: ae.c Event Loop server.el got initialized during initServer. The main event loop is created, serverCron and module_pipe events are registered. beforeSleep and afterSleep are also configured on the event loop.\nconnSocketAcceptHandler Code Path: socket.c connSocketAcceptHandler is the accept handler for the default CT_Socket type.\nanetTcpAccept returns a file descriptor for the accepted connection. Code Path: anet.c connCreateAcceptedSocket returns a new connection for the accepted file descriptor. acceptCommonHandler checks the max connection number, creates a new client and links it on the global client list with createClient, and executes connSocketAccept to fire the module events. createClient will also register readQueryFromClient as the connection’s read handler, and register on the event loop. readQueryFromClient readQueryFromClient is the main handler to handle a pending query on a client.\nWhat’s Next ACL implementation Event loop implementation AOF implementation Blocking operation. Clustering/replication/sentinel implementation Database operations (scan, query, etc.). Active memory defragmentation Memory eviction policies Key expiration implementation. Multi command implementation Pub/Sub Data structures implementations: Hash List Set Stream String ZSet Hyperloglog listpack and quicklist Radix tree Dynamic String etc. ","wordCount":"461","inLanguage":"en","datePublished":"2022-11-10T15:21:10+08:00","dateModified":"2022-11-10T15:21:10+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://kassiansun.github.io/posts/redis-architecture/"},"publisher":{"@type":"Organization","name":"Kassian Sun","logo":{"@type":"ImageObject","url":"https://kassiansun.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kassiansun.github.io/ accesskey=h title="Kassian Sun (Alt + H)">Kassian Sun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kassiansun.github.io/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Redis Architecture</h1><div class=post-meta><span title='2022-11-10 15:21:10 +0800 +0800'>November 10, 2022</span></div></header><div class=post-content><h2 id=start-up-procedures>Start-Up Procedures<a hidden class=anchor aria-hidden=true href=#start-up-procedures>#</a></h2><ul><li><code>spt_init</code>: This procedure initializes the process&rsquo;s name and deep copy command-line arguments & environments.</li><li><code>tzset</code>.</li><li><code>zmalloc_set_oom_handler</code></li><li><code>init_genrand64</code> with timestamp and pid number. Code Path: <code>mt19937-64.c</code></li><li><code>crc64_init</code>. Code Path: <code>crc64.c</code></li><li><code>umask</code></li><li><code>dictSetHashFunctionSeed</code> with a random 16-byte seed. Code Path: <code>dict.c</code></li><li><code>initServerConfig</code></li><li><code>ACLInit</code>. Code Path: <code>acl.c</code></li><li><code>moduleInitModulesSystem</code>. Code Path: <code>module.c</code></li><li><code>connTypeInitialize</code>. Code Path: <code>connection.c</code></li><li><code>initSentinelConfig</code> and <code>initSentinel</code> if the server was started in sentinel mode. Code Path: <code>sentinel.c</code></li><li>Run <code>redis_check_aof_main</code> or <code>redis_check_rdb_main</code> and exit. Code Path: <code>redis-check-aof.c</code>, <code>redis-check-rdb.c</code></li><li>Parse command-line options and <code>loadServerConfig</code>. Code Path: <code>config.c</code>.</li><li><code>sentinelCheckConfigFile</code> if it&rsquo;s in sentinel mode. Code Path: <code>sentinel.c</code></li><li>Check whether the server is supervised by <code>upstart</code> or <code>systemd</code>.</li><li><code>daemonize</code> if required.</li><li><code>initServer</code>. It initializes the global <code>redisServer</code> structure.</li><li><code>createPidFile</code> if required.</li><li><code>redisSetProcTitle</code> if required.</li><li><code>checkTcpBacklogSettings</code>.</li><li><code>clusterInit</code> if it&rsquo;s in cluster mode. Code Path: <code>cluster.c</code></li><li><code>moduleLoadFromQueue</code>. Code Path: <code>module.c</code>.</li><li><code>ACLLoadUsersAtStartup</code>, Code path: <code>acl.c</code>.</li><li><code>initListeners</code>. Redis supports multiple types of listeners, and each one has its own accept handling logic. The listeners will be registered by <code>aeCreateFileEvent</code></li><li><code>clusterInitListeners</code> if it&rsquo;s in cluster mode. Code Path: <code>cluster.c</code></li><li><code>bioInit</code> initializes the redis&rsquo;s background I/O. Code Path: <code>bio.c</code></li><li><code>initThreadedIO</code> initializes the threaded I/O. Code Path: <code>networking.c</code></li><li><code>set_jemalloc_bg_thread</code>.</li><li>If it&rsquo;s not sentinel mode:<ul><li><code>aofLoadManifestFromDisk</code>. Code Path: <code>aof.c</code></li><li><code>loadDataFromDisk</code>. It will either load the AOF file with <code>loadAppendOnlyFiles</code>, or load the RDB file with <code>rdbLoad</code> and initialize the replication backlog with <code>createReplicationBacklog</code>.<ul><li>RDB Code Path: <code>rdb.c</code></li></ul></li><li><code>aofOpenIfNeededOnServerStart</code> to open the AOF file on disk. Code Path: <code>aof.c</code></li><li><code>aofDelHistoryFiles</code> to clear the <code>history_aof_list</code>. Code Path: <code>aof.c</code></li><li><code>verifyClusterConfigWithData</code> check the cluster slots. Note that cluster mode only allows data in db 0. Code Path: <code>cluster.c</code></li></ul></li><li>Else, do <code>sentinelIsRunning</code>.</li><li><code>redisSetCpuAffinity</code></li><li><code>setOOMScoreAdj</code> will update the value in <code>/proc/self/oom_score_adj</code></li><li><code>aeMain</code> starts the event loop. <code>aeDeleteEventLoop</code> after the event loop is finished. Code Path: <code>ae.c</code></li></ul><h2 id=event-loop>Event Loop<a hidden class=anchor aria-hidden=true href=#event-loop>#</a></h2><p><code>server.el</code> got initialized during <code>initServer</code>. The main event loop is created, <code>serverCron</code> and <code>module_pipe</code> events are registered.
<code>beforeSleep</code> and <code>afterSleep</code> are also configured on the event loop.</p><h2 id=connsocketaccepthandler><code>connSocketAcceptHandler</code><a hidden class=anchor aria-hidden=true href=#connsocketaccepthandler>#</a></h2><ul><li>Code Path: <code>socket.c</code></li></ul><p><code>connSocketAcceptHandler</code> is the accept handler for the default <code>CT_Socket</code> type.</p><ul><li><code>anetTcpAccept</code> returns a file descriptor for the accepted connection. Code Path: <code>anet.c</code></li><li><code>connCreateAcceptedSocket</code> returns a new <code>connection</code> for the accepted file descriptor.</li><li><code>acceptCommonHandler</code> checks the max connection number, creates a new <code>client</code> and links it on the global client list with <code>createClient</code>,
and executes <code>connSocketAccept</code> to fire the module events.<ul><li><code>createClient</code> will also register <code>readQueryFromClient</code> as the connection&rsquo;s read handler, and register on the event loop.</li></ul></li></ul><h2 id=readqueryfromclient><code>readQueryFromClient</code><a hidden class=anchor aria-hidden=true href=#readqueryfromclient>#</a></h2><p><code>readQueryFromClient</code> is the main handler to handle a pending query on a client.</p><h2 id=whats-next>What&rsquo;s Next<a hidden class=anchor aria-hidden=true href=#whats-next>#</a></h2><ul><li>ACL implementation</li><li>Event loop implementation</li><li>AOF implementation</li><li>Blocking operation.</li><li>Clustering/replication/sentinel implementation</li><li>Database operations (scan, query, etc.).</li><li>Active memory defragmentation</li><li>Memory eviction policies</li><li>Key expiration implementation.</li><li>Multi command implementation</li><li>Pub/Sub</li><li>Data structures implementations:<ul><li>Hash</li><li>List</li><li>Set</li><li>Stream</li><li>String</li><li>ZSet</li><li>Hyperloglog</li><li>listpack and quicklist</li><li>Radix tree</li><li>Dynamic String</li><li>etc.</li></ul></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://kassiansun.github.io/tags/redis/>redis</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://kassiansun.github.io/>Kassian Sun</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>