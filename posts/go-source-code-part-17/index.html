<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Go Runtime Implementations: Network Polling | Kassian Sun</title>
<meta name=keywords content="go"><meta name=description content="Code Path: src/runtime/netpoll.go Network polling is platform-dependent, the following is of BSD family operating systems (based on kqueue).
netpollinit Initialize a kqueue descriptor, and set CLOSEXEC flag on it. Initialize a non-blocking pipe, and use the reader/writer for netpollBreak. netpollBreak will try to write to the pipe and interrupt the kevent. netpoll netpoll is used to check the connections and return a list of g ready to run. It can block for delay ns at most."><meta name=author content><link rel=canonical href=https://blog.kassiansun.com/posts/go-source-code-part-17/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.kassiansun.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.kassiansun.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.kassiansun.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.kassiansun.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.kassiansun.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.kassiansun.com/posts/go-source-code-part-17/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-E9FSQ1R0HV"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E9FSQ1R0HV")}</script><meta property="og:title" content="Go Runtime Implementations: Network Polling"><meta property="og:description" content="Code Path: src/runtime/netpoll.go Network polling is platform-dependent, the following is of BSD family operating systems (based on kqueue).
netpollinit Initialize a kqueue descriptor, and set CLOSEXEC flag on it. Initialize a non-blocking pipe, and use the reader/writer for netpollBreak. netpollBreak will try to write to the pipe and interrupt the kevent. netpoll netpoll is used to check the connections and return a list of g ready to run. It can block for delay ns at most."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kassiansun.com/posts/go-source-code-part-17/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-05T08:56:11+08:00"><meta property="article:modified_time" content="2022-11-05T08:56:11+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go Runtime Implementations: Network Polling"><meta name=twitter:description content="Code Path: src/runtime/netpoll.go Network polling is platform-dependent, the following is of BSD family operating systems (based on kqueue).
netpollinit Initialize a kqueue descriptor, and set CLOSEXEC flag on it. Initialize a non-blocking pipe, and use the reader/writer for netpollBreak. netpollBreak will try to write to the pipe and interrupt the kevent. netpoll netpoll is used to check the connections and return a list of g ready to run. It can block for delay ns at most."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.kassiansun.com/posts/"},{"@type":"ListItem","position":2,"name":"Go Runtime Implementations: Network Polling","item":"https://blog.kassiansun.com/posts/go-source-code-part-17/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Go Runtime Implementations: Network Polling","name":"Go Runtime Implementations: Network Polling","description":"Code Path: src/runtime/netpoll.go Network polling is platform-dependent, the following is of BSD family operating systems (based on kqueue).\nnetpollinit Initialize a kqueue descriptor, and set CLOSEXEC flag on it. Initialize a non-blocking pipe, and use the reader/writer for netpollBreak. netpollBreak will try to write to the pipe and interrupt the kevent. netpoll netpoll is used to check the connections and return a list of g ready to run. It can block for delay ns at most.","keywords":["go"],"articleBody":" Code Path: src/runtime/netpoll.go Network polling is platform-dependent, the following is of BSD family operating systems (based on kqueue).\nnetpollinit Initialize a kqueue descriptor, and set CLOSEXEC flag on it. Initialize a non-blocking pipe, and use the reader/writer for netpollBreak. netpollBreak will try to write to the pipe and interrupt the kevent. netpoll netpoll is used to check the connections and return a list of g ready to run. It can block for delay ns at most. The delay parameter will be passed to kevent syscall.\nCall kevent, fetch at most 64 keventt. Iterate through each keventt. If it’s a blocking call and there’s some data on netpollBreakRd, read 16-byte data from it. Get the mode value based on keventt.filter. Get the pollDesc information from keventt.udata. Call netpollready to populate the gList. Return the gList. netpollready netpollready calls netpollunlock to swap the pending g of pollDesc to pdReady, and return the pending g.\nnetpollblock Tries to swap the pending g of pollDesc to pdWaiting, or return immediately if it’s pdReady. gopark. Check the pending g and return its status. internal/poll.FD poll.FD is the underlying implementation of file descriptor used by net package.\nOpen If the FD is not pollable, there’s nothing to do. Initialize a pollDesc and use it as runtimeCtx. This is done by poll_runtime_pollOpen: Get a pollDesc from cache. Lock the `pollDesc, set the file descriptor and initialize all other fields. Register read and write event with kevent. Close Call increfAndClose, wake up all waiters and notify the closing status. Call poll_runtime_pollUnblock, wait for the g ready to consume the pollDesc, and schedule these g to run later. Release the FD, and return the underlying pollDesc back to the cache, then close the system’s file descriptor. Wait for the close semaphore. Read Acquire the read lock. Reset the descriptor mode to r. Do syscall to read the file descriptor, block and wait if necessary. Write Acquire the write lock. Reset the descriptor mode to w. Do syscall to write the file descriptor, block and wait if necessary. ","wordCount":"338","inLanguage":"en","datePublished":"2022-11-05T08:56:11+08:00","dateModified":"2022-11-05T08:56:11+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.kassiansun.com/posts/go-source-code-part-17/"},"publisher":{"@type":"Organization","name":"Kassian Sun","logo":{"@type":"ImageObject","url":"https://blog.kassiansun.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.kassiansun.com/ accesskey=h title="Kassian Sun (Alt + H)">Kassian Sun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.kassiansun.com/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Go Runtime Implementations: Network Polling</h1><div class=post-meta><span title='2022-11-05 08:56:11 +0800 +0800'>November 5, 2022</span></div></header><div class=post-content><ul><li>Code Path: <code>src/runtime/netpoll.go</code></li></ul><p>Network polling is platform-dependent, the following is of BSD family operating systems (based on <a href="https://www.freebsd.org/cgi/man.cgi?query=kqueue&apropos=0&sektion=2&manpath=FreeBSD+14.0-current&arch=default&format=html">kqueue</a>).</p><h2 id=netpollinit><code>netpollinit</code><a hidden class=anchor aria-hidden=true href=#netpollinit>#</a></h2><ul><li>Initialize a <code>kqueue</code> descriptor, and set <code>CLOSEXEC</code> flag on it.</li><li>Initialize a non-blocking pipe, and use the reader/writer for <code>netpollBreak</code>.<ul><li><code>netpollBreak</code> will try to write to the pipe and interrupt the <code>kevent</code>.</li></ul></li></ul><h2 id=netpoll><code>netpoll</code><a hidden class=anchor aria-hidden=true href=#netpoll>#</a></h2><p><code>netpoll</code> is used to check the connections and return a list of <code>g</code> ready to run. It can block for <code>delay</code> ns at most.
The <code>delay</code> parameter will be passed to <code>kevent</code> syscall.</p><ul><li>Call <code>kevent</code>, fetch at most 64 <code>keventt</code>.</li><li>Iterate through each <code>keventt</code>.<ul><li>If it&rsquo;s a blocking call and there&rsquo;s some data on <code>netpollBreakRd</code>, read 16-byte data from it.</li><li>Get the <code>mode</code> value based on <code>keventt.filter</code>.</li><li>Get the <code>pollDesc</code> information from <code>keventt.udata</code>.</li><li>Call <code>netpollready</code> to populate the <code>gList</code>.</li></ul></li><li>Return the <code>gList</code>.</li></ul><h3 id=netpollready><code>netpollready</code><a hidden class=anchor aria-hidden=true href=#netpollready>#</a></h3><p><code>netpollready</code> calls <code>netpollunlock</code> to swap the pending <code>g</code> of <code>pollDesc</code> to <code>pdReady</code>, and return the pending <code>g</code>.</p><h3 id=netpollblock><code>netpollblock</code><a hidden class=anchor aria-hidden=true href=#netpollblock>#</a></h3><ul><li>Tries to swap the pending <code>g</code> of <code>pollDesc</code> to <code>pdWaiting</code>, or return immediately if it&rsquo;s <code>pdReady</code>.</li><li><code>gopark</code>.</li><li>Check the pending <code>g</code> and return its status.</li></ul><h2 id=internalpollfd><code>internal/poll.FD</code><a hidden class=anchor aria-hidden=true href=#internalpollfd>#</a></h2><p><code>poll.FD</code> is the underlying implementation of file descriptor used by <code>net</code> package.</p><h3 id=open>Open<a hidden class=anchor aria-hidden=true href=#open>#</a></h3><ul><li>If the <code>FD</code> is not pollable, there&rsquo;s nothing to do.</li><li>Initialize a <code>pollDesc</code> and use it as <code>runtimeCtx</code>. This is done by <code>poll_runtime_pollOpen</code>:<ul><li>Get a <code>pollDesc</code> from cache.</li><li>Lock the `pollDesc, set the file descriptor and initialize all other fields.</li><li>Register read and write event with <code>kevent</code>.</li></ul></li></ul><h3 id=close>Close<a hidden class=anchor aria-hidden=true href=#close>#</a></h3><ul><li>Call <code>increfAndClose</code>, wake up all waiters and notify the closing status.</li><li>Call <code>poll_runtime_pollUnblock</code>, wait for the g ready to consume the <code>pollDesc</code>, and schedule these <code>g</code> to run later.</li><li>Release the <code>FD</code>, and return the underlying <code>pollDesc</code> back to the cache, then close the system&rsquo;s file descriptor.</li><li>Wait for the close semaphore.</li></ul><h3 id=read>Read<a hidden class=anchor aria-hidden=true href=#read>#</a></h3><ul><li>Acquire the read lock.</li><li>Reset the descriptor mode to <code>r</code>.</li><li>Do syscall to read the file descriptor, block and wait if necessary.</li></ul><h3 id=write>Write<a hidden class=anchor aria-hidden=true href=#write>#</a></h3><ul><li>Acquire the write lock.</li><li>Reset the descriptor mode to <code>w</code>.</li><li>Do syscall to write the file descriptor, block and wait if necessary.</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.kassiansun.com/tags/go/>Go</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.kassiansun.com/>Kassian Sun</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>