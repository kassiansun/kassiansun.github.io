<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Go Runtime Implementations: Channel | Kassian Sun</title><meta name=keywords content="go"><meta name=description content="Path: src/runtime/chan.go Compilation When you make a chan with make function, the compiler will expand the expression to the makechan implementation. The actual expansion happens at cmd/compile/internal/walk/expr.go. The runtime will determine whether to use makechan or makechan64.
Type Definitions type _type _type is used as the internal representation of a go type. The same structure is defined multiple times across the go runtime. _type stores the following fields:
type chantype makechan only uses chantype."><meta name=author content><link rel=canonical href=https://blog.kassiansun.com/posts/go-source-code-part-7/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.kassiansun.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.kassiansun.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.kassiansun.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.kassiansun.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.kassiansun.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-E9FSQ1R0HV"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E9FSQ1R0HV",{anonymize_ip:!1})}</script><meta property="og:title" content="Go Runtime Implementations: Channel"><meta property="og:description" content="Path: src/runtime/chan.go Compilation When you make a chan with make function, the compiler will expand the expression to the makechan implementation. The actual expansion happens at cmd/compile/internal/walk/expr.go. The runtime will determine whether to use makechan or makechan64.
Type Definitions type _type _type is used as the internal representation of a go type. The same structure is defined multiple times across the go runtime. _type stores the following fields:
type chantype makechan only uses chantype."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kassiansun.com/posts/go-source-code-part-7/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-29T11:24:26+08:00"><meta property="article:modified_time" content="2022-09-29T11:24:26+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go Runtime Implementations: Channel"><meta name=twitter:description content="Path: src/runtime/chan.go Compilation When you make a chan with make function, the compiler will expand the expression to the makechan implementation. The actual expansion happens at cmd/compile/internal/walk/expr.go. The runtime will determine whether to use makechan or makechan64.
Type Definitions type _type _type is used as the internal representation of a go type. The same structure is defined multiple times across the go runtime. _type stores the following fields:
type chantype makechan only uses chantype."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.kassiansun.com/posts/"},{"@type":"ListItem","position":2,"name":"Go Runtime Implementations: Channel","item":"https://blog.kassiansun.com/posts/go-source-code-part-7/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Go Runtime Implementations: Channel","name":"Go Runtime Implementations: Channel","description":"Path: src/runtime/chan.go Compilation When you make a chan with make function, the compiler will expand the expression to the makechan implementation. The actual expansion happens at cmd/compile/internal/walk/expr.go. The runtime will determine whether to use makechan or makechan64.\nType Definitions type _type _type is used as the internal representation of a go type. The same structure is defined multiple times across the go runtime. _type stores the following fields:\ntype chantype makechan only uses chantype.","keywords":["go"],"articleBody":" Path: src/runtime/chan.go Compilation When you make a chan with make function, the compiler will expand the expression to the makechan implementation. The actual expansion happens at cmd/compile/internal/walk/expr.go. The runtime will determine whether to use makechan or makechan64.\nType Definitions type _type _type is used as the internal representation of a go type. The same structure is defined multiple times across the go runtime. _type stores the following fields:\ntype chantype makechan only uses chantype.elem, the other fields are used by the type system.\ntype waitq waitq is a queue of waiting goroutines. There’s a special flag to check whether goroutine has grabbed the channel locks but not removed itself from waitq. If the flag is true, dequeue will continue and try to find the next valid goroutine.\ntype hchan hchan used a circular queue to save the buffered channel data.\nRuntime Implementation makechan Check the element’s size and alignment, and the expected chan’s size. Allocate the memory for hchan. The memory allocation is very dense and the runtime will try to utilize the memory at its best effort. chansend Check whether the channel is unresponsive and return. Lock the channel Check whether the channel is closed. Get a receiver from waitq, and send the data directly to that goroutine, then return true. If the channel buffer is not full yet, memmove the data to the circular queue, then return true. If it’s not a blocking operation, return false. Block the current goroutine, and put it on the sendq. send send will send the data to the target goroutine. It happens when the target goroutine is waiting and the data arrived on the channel. The send operation will copy the data directly to the target goroutine’s stack, and make the target goroutine as ready state.\nchanrecv Check whether the channel is unresponsive and return. Lock the channel If the queue is closed and the circular queue is empty, return. If there’s a waiting goroutine on sendq, recv immediately and return. Move the data from the circular queue to the target memory address. If it’s not a blocking operation, return false. Block the current goroutine, and put it on the waitq. recv recv happens under a similar condition to send.\nIf the channel is unbuffered, recvDirect from the sending goroutine to receiving goroutine. Read the data from the circular queue first, and move the data to the target memory address. Mark the sending goroutine as ready to run. Note that the receiving goroutine is already running. What’s Next Go’s typing system Go’s routines implementation. ","wordCount":"422","inLanguage":"en","datePublished":"2022-09-29T11:24:26+08:00","dateModified":"2022-09-29T11:24:26+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.kassiansun.com/posts/go-source-code-part-7/"},"publisher":{"@type":"Organization","name":"Kassian Sun","logo":{"@type":"ImageObject","url":"https://blog.kassiansun.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.kassiansun.com/ accesskey=h title="Kassian Sun (Alt + H)">Kassian Sun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.kassiansun.com/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Go Runtime Implementations: Channel</h1><div class=post-meta><span title='2022-09-29 11:24:26 +0800 +0800'>September 29, 2022</span></div></header><div class=post-content><ul><li>Path: <code>src/runtime/chan.go</code></li></ul><h2 id=compilation>Compilation<a hidden class=anchor aria-hidden=true href=#compilation>#</a></h2><p>When you make a chan with <code>make</code> function, the compiler will expand the expression to the <code>makechan</code> implementation. The actual expansion happens
at <code>cmd/compile/internal/walk/expr.go</code>. The runtime will determine whether to use <code>makechan</code> or <code>makechan64</code>.</p><h2 id=type-definitions>Type Definitions<a hidden class=anchor aria-hidden=true href=#type-definitions>#</a></h2><h3 id=type-_type><code>type _type</code><a hidden class=anchor aria-hidden=true href=#type-_type>#</a></h3><p><code>_type</code> is used as the internal representation of a <code>go</code> type. The same structure is defined multiple times across the <code>go</code> runtime.
<code>_type</code> stores the following fields:</p><h3 id=type-chantype><code>type chantype</code><a hidden class=anchor aria-hidden=true href=#type-chantype>#</a></h3><p><code>makechan</code> only uses <code>chantype.elem</code>, the other fields are used by the type system.</p><h3 id=type-waitq><code>type waitq</code><a hidden class=anchor aria-hidden=true href=#type-waitq>#</a></h3><p><code>waitq</code> is a queue of waiting goroutines. There&rsquo;s a special flag to check whether goroutine has grabbed the channel locks but not removed itself from <code>waitq</code>.
If the flag is true, <code>dequeue</code> will continue and try to find the next valid goroutine.</p><h3 id=type-hchan><code>type hchan</code><a hidden class=anchor aria-hidden=true href=#type-hchan>#</a></h3><p><code>hchan</code> used a circular queue to save the buffered channel data.</p><h2 id=runtime-implementation>Runtime Implementation<a hidden class=anchor aria-hidden=true href=#runtime-implementation>#</a></h2><h3 id=makechan><code>makechan</code><a hidden class=anchor aria-hidden=true href=#makechan>#</a></h3><ul><li>Check the element&rsquo;s size and alignment, and the expected <code>chan</code>&rsquo;s size.</li><li>Allocate the memory for <code>hchan</code>. The memory allocation is very dense and the runtime will try to utilize the memory at its best effort.</li></ul><h3 id=chansend><code>chansend</code><a hidden class=anchor aria-hidden=true href=#chansend>#</a></h3><ul><li>Check whether the channel is unresponsive and return.</li><li>Lock the channel</li><li>Check whether the channel is closed.</li><li>Get a receiver from <code>waitq</code>, and send the data directly to that goroutine, then return true.</li><li>If the channel buffer is not full yet, <code>memmove</code> the data to the circular queue, then return true.</li><li>If it&rsquo;s not a blocking operation, return false.</li><li>Block the current goroutine, and put it on the <code>sendq</code>.</li></ul><h3 id=send><code>send</code><a hidden class=anchor aria-hidden=true href=#send>#</a></h3><p><code>send</code> will send the data to the target goroutine. It happens when the target goroutine is waiting and the data arrived on the channel.
The <code>send</code> operation will copy the data directly to the target goroutine&rsquo;s stack, and make the target goroutine as ready state.</p><h3 id=chanrecv><code>chanrecv</code><a hidden class=anchor aria-hidden=true href=#chanrecv>#</a></h3><ul><li>Check whether the channel is unresponsive and return.</li><li>Lock the channel</li><li>If the queue is closed and the circular queue is empty, return.</li><li>If there&rsquo;s a waiting goroutine on <code>sendq</code>, <code>recv</code> immediately and return.</li><li>Move the data from the circular queue to the target memory address.</li><li>If it&rsquo;s not a blocking operation, return false.</li><li>Block the current goroutine, and put it on the <code>waitq</code>.</li></ul><h3 id=recv><code>recv</code><a hidden class=anchor aria-hidden=true href=#recv>#</a></h3><p><code>recv</code> happens under a similar condition to <code>send</code>.</p><ul><li>If the channel is unbuffered, <code>recvDirect</code> from the sending goroutine to receiving goroutine.</li><li>Read the data from the circular queue first, and move the data to the target memory address.</li><li>Mark the sending goroutine as ready to run. Note that the receiving goroutine is already running.</li></ul><h2 id=whats-next>What&rsquo;s Next<a hidden class=anchor aria-hidden=true href=#whats-next>#</a></h2><ul><li>Go&rsquo;s typing system</li><li>Go&rsquo;s routines implementation.</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.kassiansun.com/tags/go/>go</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.kassiansun.com/>Kassian Sun</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>