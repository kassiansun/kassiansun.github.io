<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Travesal Through The Go Compiler, Part 3 | Kassian Sun</title>
<meta name=keywords content="go"><meta name=description content='BuildToolchain BuildToolchain is initialized as noToolchain{} by default, then it&rsquo;s set dynamically to gccgo or gc. Both implementations are wrappers around the binary toolchains installed on the machine. For gc, the delegations are as follows:
BuildToolchain.gc - base.Tool("compile") BuildToolchain.cc - base.Tool("cgo"). Actually cgo has been executed before the compile and cfiles has been cleared, so BuildToolchain.cc should never be called and it always returns an error. BuildToolchain.asm - base.Tool("asm") BuildToolchain.pack - base.'><meta name=author content><link rel=canonical href=https://blog.kassiansun.com/posts/go-source-code-part-3/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.kassiansun.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.kassiansun.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.kassiansun.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.kassiansun.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.kassiansun.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.kassiansun.com/posts/go-source-code-part-3/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-E9FSQ1R0HV"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E9FSQ1R0HV")}</script><meta property="og:title" content="Travesal Through The Go Compiler, Part 3"><meta property="og:description" content='BuildToolchain BuildToolchain is initialized as noToolchain{} by default, then it&rsquo;s set dynamically to gccgo or gc. Both implementations are wrappers around the binary toolchains installed on the machine. For gc, the delegations are as follows:
BuildToolchain.gc - base.Tool("compile") BuildToolchain.cc - base.Tool("cgo"). Actually cgo has been executed before the compile and cfiles has been cleared, so BuildToolchain.cc should never be called and it always returns an error. BuildToolchain.asm - base.Tool("asm") BuildToolchain.pack - base.'><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kassiansun.com/posts/go-source-code-part-3/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-17T09:29:52+08:00"><meta property="article:modified_time" content="2022-09-17T09:29:52+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Travesal Through The Go Compiler, Part 3"><meta name=twitter:description content='BuildToolchain BuildToolchain is initialized as noToolchain{} by default, then it&rsquo;s set dynamically to gccgo or gc. Both implementations are wrappers around the binary toolchains installed on the machine. For gc, the delegations are as follows:
BuildToolchain.gc - base.Tool("compile") BuildToolchain.cc - base.Tool("cgo"). Actually cgo has been executed before the compile and cfiles has been cleared, so BuildToolchain.cc should never be called and it always returns an error. BuildToolchain.asm - base.Tool("asm") BuildToolchain.pack - base.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.kassiansun.com/posts/"},{"@type":"ListItem","position":2,"name":"Travesal Through The Go Compiler, Part 3","item":"https://blog.kassiansun.com/posts/go-source-code-part-3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Travesal Through The Go Compiler, Part 3","name":"Travesal Through The Go Compiler, Part 3","description":"BuildToolchain BuildToolchain is initialized as noToolchain{} by default, then it\u0026rsquo;s set dynamically to gccgo or gc. Both implementations are wrappers around the binary toolchains installed on the machine. For gc, the delegations are as follows:\nBuildToolchain.gc - base.Tool(\u0026quot;compile\u0026quot;) BuildToolchain.cc - base.Tool(\u0026quot;cgo\u0026quot;). Actually cgo has been executed before the compile and cfiles has been cleared, so BuildToolchain.cc should never be called and it always returns an error. BuildToolchain.asm - base.Tool(\u0026quot;asm\u0026quot;) BuildToolchain.pack - base.","keywords":["go"],"articleBody":"BuildToolchain BuildToolchain is initialized as noToolchain{} by default, then it’s set dynamically to gccgo or gc. Both implementations are wrappers around the binary toolchains installed on the machine. For gc, the delegations are as follows:\nBuildToolchain.gc - base.Tool(\"compile\") BuildToolchain.cc - base.Tool(\"cgo\"). Actually cgo has been executed before the compile and cfiles has been cleared, so BuildToolchain.cc should never be called and it always returns an error. BuildToolchain.asm - base.Tool(\"asm\") BuildToolchain.pack - base.Tool(\"pack\") BuildToolchain.ld - base.Tool(\"link\") cmd/compile aka base.Tool(“compile”) Entry point: internal/gc.Main It’s a standalone binary which means all packages path assumes a relative path to go/src/cmd/compile. gc.Main will get an archInit function as the parameter, this function populates the ssagen.ArchInfo which contains necessary architecture information.\nInitialize a new obj.Link as context. Parse compiler flags - internal/base.CmdFlags. Initialize types.Pkg information. Save DWARF info from compiler flags. Initialize ssagen by OS environments and initialize the table, also initialize other architecture-specific types information. Initialize typecheck noder.LoadPackage - This is the main step for compiling and type checking, after this step, typecheck.Target (type of ir.Package) will be ready to use. Initialize ssagen configuration. Build the init function for the package. Eliminate dead codes. Compute Addrtaken for names. \u003c- What’s this? Wrapping the types, the imported types are assumed to be wrapped already. devirtualize.Func all Decls with Op == ir.ODCLFUNC Build init task. Generate ABI wrappers. Do escape analysis. Compile functions in parallel. Dump everything to the object file. What’s Next ssa architecture. ABI architecture. types system. ir structure. escape analysis. Object file structure. ","wordCount":"249","inLanguage":"en","datePublished":"2022-09-17T09:29:52+08:00","dateModified":"2022-09-17T09:29:52+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.kassiansun.com/posts/go-source-code-part-3/"},"publisher":{"@type":"Organization","name":"Kassian Sun","logo":{"@type":"ImageObject","url":"https://blog.kassiansun.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.kassiansun.com/ accesskey=h title="Kassian Sun (Alt + H)">Kassian Sun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.kassiansun.com/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Travesal Through The Go Compiler, Part 3</h1><div class=post-meta><span title='2022-09-17 09:29:52 +0800 +0800'>September 17, 2022</span></div></header><div class=post-content><h2 id=buildtoolchain>BuildToolchain<a hidden class=anchor aria-hidden=true href=#buildtoolchain>#</a></h2><p>BuildToolchain is initialized as <code>noToolchain{}</code> by default, then it&rsquo;s set dynamically to <code>gccgo</code> or <code>gc</code>.
Both implementations are wrappers around the binary toolchains installed on the machine. For <code>gc</code>, the delegations are as follows:</p><ul><li><code>BuildToolchain.gc</code> - <code>base.Tool("compile")</code></li><li><code>BuildToolchain.cc</code> - <code>base.Tool("cgo")</code>. Actually <code>cgo</code> has been executed before the compile and <code>cfiles</code> has been cleared, so <code>BuildToolchain.cc</code> should never be called and it always returns an error.</li><li><code>BuildToolchain.asm</code> - <code>base.Tool("asm")</code></li><li><code>BuildToolchain.pack</code> - <code>base.Tool("pack")</code></li><li><code>BuildToolchain.ld</code> - <code>base.Tool("link")</code></li></ul><h2 id=cmdcompile-aka-basetoolcompile><code>cmd/compile</code> aka base.Tool(&ldquo;compile&rdquo;)<a hidden class=anchor aria-hidden=true href=#cmdcompile-aka-basetoolcompile>#</a></h2><ul><li>Entry point: <code>internal/gc.Main</code></li></ul><p>It&rsquo;s a standalone binary which means all packages path assumes a relative path to <code>go/src/cmd/compile</code>.
<code>gc.Main</code> will get an <code>archInit</code> function as the parameter, this function populates the <code>ssagen.ArchInfo</code> which contains necessary architecture information.</p><ul><li>Initialize a new <code>obj.Link</code> as context.</li><li>Parse compiler flags - <code>internal/base.CmdFlags</code>.</li><li>Initialize <code>types.Pkg</code> information.</li><li>Save DWARF info from compiler flags.</li><li>Initialize <code>ssagen</code> by OS environments and initialize the table, also initialize other architecture-specific <code>types</code> information.</li><li>Initialize <code>typecheck</code></li><li><code>noder.LoadPackage</code> - This is the main step for compiling and type checking, after this step, <code>typecheck.Target</code> (type of <code>ir.Package</code>) will be ready to use.</li><li>Initialize <code>ssagen</code> configuration.</li><li>Build the <code>init</code> function for the package.</li><li>Eliminate dead codes.</li><li>Compute Addrtaken for names. &lt;- What&rsquo;s this?</li><li>Wrapping the types, the imported types are assumed to be wrapped already.</li><li><code>devirtualize.Func</code> all <code>Decls</code> with <code>Op == ir.ODCLFUNC</code></li><li>Build init task.</li><li>Generate ABI wrappers.</li><li>Do escape analysis.</li><li>Compile functions in parallel.</li><li>Dump everything to the object file.</li></ul><h2 id=whats-next>What&rsquo;s Next<a hidden class=anchor aria-hidden=true href=#whats-next>#</a></h2><ul><li><code>ssa</code> architecture.</li><li>ABI architecture.</li><li><code>types</code> system.</li><li><code>ir</code> structure.</li><li>escape analysis.</li><li>Object file structure.</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.kassiansun.com/tags/go/>Go</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.kassiansun.com/>Kassian Sun</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>