<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Traversal Through The Go Compiler, Part 1 | Kassian Sun</title><meta name=keywords content="go"><meta name=description content="Set Up the Environment vim-go doesn&rsquo;t support travesal through the go source code, so I switch to vscode and it works out of box (with Go plugin && gopls installed).
Start Point (go run) File: src/cmd/go/main.go Declaration: run.CmdRun Function: run.runRun Key data structures: build.Context work.Builder load.Package work.Action The runRun function will go through several stages:
Check shouldUseOutsideModuleMode. This procedure is used by go run cmd@version work.BuildInit. This will setup the build context: Initialize modload module."><meta name=author content><link rel=canonical href=https://blog.kassiansun.com/posts/go-source-code-part-1/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.kassiansun.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.kassiansun.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.kassiansun.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.kassiansun.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.kassiansun.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-E9FSQ1R0HV"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E9FSQ1R0HV",{anonymize_ip:!1})}</script><meta property="og:title" content="Traversal Through The Go Compiler, Part 1"><meta property="og:description" content="Set Up the Environment vim-go doesn&rsquo;t support travesal through the go source code, so I switch to vscode and it works out of box (with Go plugin && gopls installed).
Start Point (go run) File: src/cmd/go/main.go Declaration: run.CmdRun Function: run.runRun Key data structures: build.Context work.Builder load.Package work.Action The runRun function will go through several stages:
Check shouldUseOutsideModuleMode. This procedure is used by go run cmd@version work.BuildInit. This will setup the build context: Initialize modload module."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kassiansun.com/posts/go-source-code-part-1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-15T08:48:31+08:00"><meta property="article:modified_time" content="2022-09-15T08:48:31+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Traversal Through The Go Compiler, Part 1"><meta name=twitter:description content="Set Up the Environment vim-go doesn&rsquo;t support travesal through the go source code, so I switch to vscode and it works out of box (with Go plugin && gopls installed).
Start Point (go run) File: src/cmd/go/main.go Declaration: run.CmdRun Function: run.runRun Key data structures: build.Context work.Builder load.Package work.Action The runRun function will go through several stages:
Check shouldUseOutsideModuleMode. This procedure is used by go run cmd@version work.BuildInit. This will setup the build context: Initialize modload module."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.kassiansun.com/posts/"},{"@type":"ListItem","position":2,"name":"Traversal Through The Go Compiler, Part 1","item":"https://blog.kassiansun.com/posts/go-source-code-part-1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Traversal Through The Go Compiler, Part 1","name":"Traversal Through The Go Compiler, Part 1","description":"Set Up the Environment vim-go doesn\u0026rsquo;t support travesal through the go source code, so I switch to vscode and it works out of box (with Go plugin \u0026amp;\u0026amp; gopls installed).\nStart Point (go run) File: src/cmd/go/main.go Declaration: run.CmdRun Function: run.runRun Key data structures: build.Context work.Builder load.Package work.Action The runRun function will go through several stages:\nCheck shouldUseOutsideModuleMode. This procedure is used by go run cmd@version work.BuildInit. This will setup the build context: Initialize modload module.","keywords":["go"],"articleBody":"Set Up the Environment vim-go doesn’t support travesal through the go source code, so I switch to vscode and it works out of box (with Go plugin \u0026\u0026 gopls installed).\nStart Point (go run) File: src/cmd/go/main.go Declaration: run.CmdRun Function: run.runRun Key data structures: build.Context work.Builder load.Package work.Action The runRun function will go through several stages:\nCheck shouldUseOutsideModuleMode. This procedure is used by go run cmd@version work.BuildInit. This will setup the build context: Initialize modload module. It will check go module flags and set up the flags, no actual module download. instrumentInit and buildModeInit, and update the default build.Context accordingly. Get a work.Builder. work.NewBuilder will check the environment and make sure it’s ready to do the actual build. Inits a load.Package from all *.go files passed to go run. load.Package has a public struct for definitions, and an internal struct for running state. Setup builder.LinkAction. LinkAction will call cacheAction (for looking up action cache, not build cache), CompileAction, and installAction (not for go run). work.Action is a DAG, the action cache depends on mode and package info. Initialize a work.Action, use the link action initialized at the above stage as dependencies. Build the work.Action with builder. Build Stage (Builder.Do) Set up the cache trim. There’s a trim.txt inside go-build cache folder, it’s used to track the timestamp of last trim action. Build the action list, visit the DAG as “depth-first post-order travelsal”. The priority will set by the list order, which means deepest will run first. writeActionGraph. Internal feature, this will dump the DAG as JSON. Set up triggers. Triggers are the inverse of dependencies, which means when the dependency ready, it will trigger its root instead of its dependencies. The handle function will do the actual jobs. Actions are run in parallel, the actual job is defined by action.Func. After actions done, update the global state. There’s a lock to make sure there’s no data races. If all dependencies finished, push the action node to ready queue and signal the readySema. Ready queue are protected with the same global state lock. Run all actions from the DAG in parallel. What’s Next Travesal through the action.Func definitions:\nBuilder.build Builder.link ","wordCount":"358","inLanguage":"en","datePublished":"2022-09-15T08:48:31+08:00","dateModified":"2022-09-15T08:48:31+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.kassiansun.com/posts/go-source-code-part-1/"},"publisher":{"@type":"Organization","name":"Kassian Sun","logo":{"@type":"ImageObject","url":"https://blog.kassiansun.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.kassiansun.com/ accesskey=h title="Kassian Sun (Alt + H)">Kassian Sun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.kassiansun.com/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Traversal Through The Go Compiler, Part 1</h1><div class=post-meta><span title='2022-09-15 08:48:31 +0800 +0800'>September 15, 2022</span></div></header><div class=post-content><h2 id=set-up-the-environment>Set Up the Environment<a hidden class=anchor aria-hidden=true href=#set-up-the-environment>#</a></h2><p><code>vim-go</code> doesn&rsquo;t support travesal through the <code>go</code> source code, so I switch to <code>vscode</code> and it works out of box (with Go plugin && <code>gopls</code> installed).</p><h2 id=start-point-go-run>Start Point (<code>go run</code>)<a hidden class=anchor aria-hidden=true href=#start-point-go-run>#</a></h2><ul><li>File: <code>src/cmd/go/main.go</code></li><li>Declaration: <code>run.CmdRun</code></li><li>Function: <code>run.runRun</code></li><li>Key data structures:<ul><li><code>build.Context</code></li><li><code>work.Builder</code></li><li><code>load.Package</code></li><li><code>work.Action</code></li></ul></li></ul><p>The <code>runRun</code> function will go through several stages:</p><ul><li>Check <code>shouldUseOutsideModuleMode</code>. This procedure is used by <code>go run cmd@version</code></li><li><code>work.BuildInit</code>. This will setup the build context:<ul><li>Initialize <code>modload</code> module. It will check go module flags and set up the flags, no actual module download.</li><li><code>instrumentInit</code> and <code>buildModeInit</code>, and update the default <code>build.Context</code> accordingly.</li></ul></li><li>Get a <code>work.Builder</code>. <code>work.NewBuilder</code> will check the environment and make sure it&rsquo;s ready to do the actual build.</li><li>Inits a <code>load.Package</code> from all <code>*.go</code> files passed to <code>go run</code>.<ul><li><code>load.Package</code> has a public struct for definitions, and an internal struct for running state.</li></ul></li><li>Setup <code>builder.LinkAction</code>. <code>LinkAction</code> will call <code>cacheAction</code> (for looking up action cache, not build cache), <code>CompileAction</code>, and <code>installAction</code> (not for <code>go run</code>).<ul><li><code>work.Action</code> is a DAG, the action cache depends on <code>mode</code> and package info.</li></ul></li><li>Initialize a <code>work.Action</code>, use the link action initialized at the above stage as dependencies.</li><li>Build the <code>work.Action</code> with builder.</li></ul><h2 id=build-stage-builderdo>Build Stage (<code>Builder.Do</code>)<a hidden class=anchor aria-hidden=true href=#build-stage-builderdo>#</a></h2><ul><li>Set up the cache trim. There&rsquo;s a <code>trim.txt</code> inside <code>go-build</code> cache folder, it&rsquo;s used to track the timestamp of last trim action.</li><li>Build the action list, visit the DAG as &ldquo;depth-first post-order travelsal&rdquo;. The priority will set by the list order, which means deepest will run first.</li><li><code>writeActionGraph</code>. Internal feature, this will dump the DAG as JSON.</li><li>Set up triggers. Triggers are the inverse of dependencies, which means when the dependency ready, it will trigger its root instead of its dependencies.</li><li>The <code>handle</code> function will do the actual jobs.<ul><li>Actions are run in parallel, the actual job is defined by <code>action.Func</code>.</li><li>After actions done, update the global state. There&rsquo;s a lock to make sure there&rsquo;s no data races.</li><li>If all dependencies finished, push the action node to ready queue and signal the <code>readySema</code>. Ready queue are protected with the same global state lock.</li></ul></li><li>Run all actions from the DAG in parallel.</li></ul><h2 id=whats-next>What&rsquo;s Next<a hidden class=anchor aria-hidden=true href=#whats-next>#</a></h2><p>Travesal through the <code>action.Func</code> definitions:</p><ul><li><code>Builder.build</code></li><li><code>Builder.link</code></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.kassiansun.com/tags/go/>go</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.kassiansun.com/>Kassian Sun</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>