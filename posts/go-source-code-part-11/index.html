<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Go Runtime Implementations: Garbage Collection | Kassian Sun</title>
<meta name=keywords content="go"><meta name=description content="Ref Garbage Collector Code Path: src/runtime/mgc.go gcinit gcinit runs after almost everything set up in schedinit.
Set sweepDrainedMask Initialize gcController with GOGC (for GC percentage control) and GOMEMLIMIT (for memory limits). Initialize work semaphores. gcenable gcenable happens in the main goroutine, right after runtime_inittask.
Start bgsweep Start bgscavenge GC GC runs a full garbage collection. Each run will finish the current GC cycle: sweep termination, mark, mark termination, and sweep."><meta name=author content><link rel=canonical href=https://blog.kassiansun.com/posts/go-source-code-part-11/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.kassiansun.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.kassiansun.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.kassiansun.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.kassiansun.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.kassiansun.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.kassiansun.com/posts/go-source-code-part-11/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-E9FSQ1R0HV"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E9FSQ1R0HV")}</script><meta property="og:title" content="Go Runtime Implementations: Garbage Collection"><meta property="og:description" content="Ref Garbage Collector Code Path: src/runtime/mgc.go gcinit gcinit runs after almost everything set up in schedinit.
Set sweepDrainedMask Initialize gcController with GOGC (for GC percentage control) and GOMEMLIMIT (for memory limits). Initialize work semaphores. gcenable gcenable happens in the main goroutine, right after runtime_inittask.
Start bgsweep Start bgscavenge GC GC runs a full garbage collection. Each run will finish the current GC cycle: sweep termination, mark, mark termination, and sweep."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kassiansun.com/posts/go-source-code-part-11/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-18T14:17:39+08:00"><meta property="article:modified_time" content="2022-10-18T14:17:39+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go Runtime Implementations: Garbage Collection"><meta name=twitter:description content="Ref Garbage Collector Code Path: src/runtime/mgc.go gcinit gcinit runs after almost everything set up in schedinit.
Set sweepDrainedMask Initialize gcController with GOGC (for GC percentage control) and GOMEMLIMIT (for memory limits). Initialize work semaphores. gcenable gcenable happens in the main goroutine, right after runtime_inittask.
Start bgsweep Start bgscavenge GC GC runs a full garbage collection. Each run will finish the current GC cycle: sweep termination, mark, mark termination, and sweep."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.kassiansun.com/posts/"},{"@type":"ListItem","position":2,"name":"Go Runtime Implementations: Garbage Collection","item":"https://blog.kassiansun.com/posts/go-source-code-part-11/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Go Runtime Implementations: Garbage Collection","name":"Go Runtime Implementations: Garbage Collection","description":"Ref Garbage Collector Code Path: src/runtime/mgc.go gcinit gcinit runs after almost everything set up in schedinit.\nSet sweepDrainedMask Initialize gcController with GOGC (for GC percentage control) and GOMEMLIMIT (for memory limits). Initialize work semaphores. gcenable gcenable happens in the main goroutine, right after runtime_inittask.\nStart bgsweep Start bgscavenge GC GC runs a full garbage collection. Each run will finish the current GC cycle: sweep termination, mark, mark termination, and sweep.","keywords":["go"],"articleBody":" Ref Garbage Collector Code Path: src/runtime/mgc.go gcinit gcinit runs after almost everything set up in schedinit.\nSet sweepDrainedMask Initialize gcController with GOGC (for GC percentage control) and GOMEMLIMIT (for memory limits). Initialize work semaphores. gcenable gcenable happens in the main goroutine, right after runtime_inittask.\nStart bgsweep Start bgscavenge GC GC runs a full garbage collection. Each run will finish the current GC cycle: sweep termination, mark, mark termination, and sweep. Then it will start a new GC cycle. Note that GC cycles can move forward to more than N+1.\nWait for the current mark phase to finish. gcStart. gcStart can be controlled by different kinds of triggers: heap size, GC period, and GC cycle number. Check whether m is preemptible or running on a non-g0. Check the trigger and run sweepone until there’s nothing to sweep. gcStart supports three modes controlled by debug.gcstoptheworld: concurrent GC and sweep, STW GC and concurrent sweep, STW GC and STW sweep. Check that all p.mcache has been flushed. Start the background marker goroutines. Set up work information. Stop the world. This is controlled by stopTheWorldWithSema of proc.go, it will try to stop all p and g. Sweep all spans. Clear all sync.Pool. gcController.startCycle. gcDrain -\u003e gcSweep. Wait for gcStart to finish marking and sweeping. Check the cycle and run sweepone until there’s nothing to sweep. Wait for the sweeping done. Marking Code Path: src/runtime/mgcmark.go Object Scanning Code Path: src/runtime/mbitmap.go src/runtime/mcheckmark.go GC will scan the module’s .data and .bss section to find all objects. An object can be found by findObject, and its GC markBits can be obtained from mspan. Large objects will be splitted into “oblets”.\nStack Scanning Code Path: src/runtime/mgcstack.go gcAssistAlloc Goroutines will call gcAssistAlloc to assist the GC.\nMemory Barriers Code Path: src/runtime/mbarrier.go The memory barriers are code snippets insert around a memory operation. Ref\nSSA Code Path: src/cmd/compile/internal/ssa/writebarrier.go ssa.writebarrier will rewrite the following instructions of a ssa.Func: OpStoreWB OpMoveWB OpZeroWB GC Implementation Code Path: src/runtime/mbitmap.go Sweeping Code Path: src/runtime/mgcsweep.go sweepone Pacing Code Path: src/runtime/mgcpacer.go gcController controls how the GC cycles will run.\nstartCycle Scavenge Code Path: src/runtime/mgcscavenge.go What’s Next Write barriers. ","wordCount":"350","inLanguage":"en","datePublished":"2022-10-18T14:17:39+08:00","dateModified":"2022-10-18T14:17:39+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.kassiansun.com/posts/go-source-code-part-11/"},"publisher":{"@type":"Organization","name":"Kassian Sun","logo":{"@type":"ImageObject","url":"https://blog.kassiansun.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.kassiansun.com/ accesskey=h title="Kassian Sun (Alt + H)">Kassian Sun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.kassiansun.com/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Go Runtime Implementations: Garbage Collection</h1><div class=post-meta><span title='2022-10-18 14:17:39 +0800 +0800'>October 18, 2022</span></div></header><div class=post-content><ul><li><a href=https://go.dev/doc/gc-guide>Ref</a></li></ul><h2 id=garbage-collector>Garbage Collector<a hidden class=anchor aria-hidden=true href=#garbage-collector>#</a></h2><ul><li>Code Path: <code>src/runtime/mgc.go</code></li></ul><h3 id=gcinit><code>gcinit</code><a hidden class=anchor aria-hidden=true href=#gcinit>#</a></h3><p><code>gcinit</code> runs after almost everything set up in <code>schedinit</code>.</p><ul><li>Set <code>sweepDrainedMask</code></li><li>Initialize <code>gcController</code> with <code>GOGC</code> (for GC percentage control) and <code>GOMEMLIMIT</code> (for memory limits).</li><li>Initialize <code>work</code> semaphores.</li></ul><h3 id=gcenable><code>gcenable</code><a hidden class=anchor aria-hidden=true href=#gcenable>#</a></h3><p><code>gcenable</code> happens in the <code>main</code> goroutine, right after <code>runtime_inittask</code>.</p><ul><li>Start <code>bgsweep</code></li><li>Start <code>bgscavenge</code></li></ul><h3 id=gc><code>GC</code><a hidden class=anchor aria-hidden=true href=#gc>#</a></h3><p><code>GC</code> runs a full garbage collection. Each run will finish the current GC cycle: sweep termination, mark, mark termination, and sweep.
Then it will start a new GC cycle. Note that GC cycles can move forward to more than <code>N+1</code>.</p><ul><li>Wait for the current mark phase to finish.</li><li><code>gcStart</code>. <code>gcStart</code> can be controlled by different kinds of triggers: heap size, GC period, and GC cycle number.<ul><li>Check whether m is preemptible or running on a non-<code>g0</code>.</li><li>Check the trigger and run <code>sweepone</code> until there&rsquo;s nothing to sweep.</li><li><code>gcStart</code> supports three modes controlled by <code>debug.gcstoptheworld</code>: concurrent GC and sweep, STW GC and concurrent sweep, STW GC and STW sweep.</li><li>Check that all <code>p.mcache</code> has been flushed.</li><li>Start the background marker goroutines.</li><li>Set up <code>work</code> information.</li><li>Stop the world. This is controlled by <code>stopTheWorldWithSema</code> of <code>proc.go</code>, it will try to stop all <code>p</code> and <code>g</code>.</li><li>Sweep all spans.</li><li>Clear all <code>sync.Pool</code>.</li><li><code>gcController.startCycle</code>.</li><li><code>gcDrain</code> -> <code>gcSweep</code>.</li></ul></li><li>Wait for <code>gcStart</code> to finish marking and sweeping.</li><li>Check the cycle and run <code>sweepone</code> until there&rsquo;s nothing to sweep.</li><li>Wait for the sweeping done.</li></ul><h2 id=marking>Marking<a hidden class=anchor aria-hidden=true href=#marking>#</a></h2><ul><li>Code Path: <code>src/runtime/mgcmark.go</code></li></ul><h3 id=object-scanning>Object Scanning<a hidden class=anchor aria-hidden=true href=#object-scanning>#</a></h3><ul><li>Code Path:<ul><li><code>src/runtime/mbitmap.go</code></li><li><code>src/runtime/mcheckmark.go</code></li></ul></li></ul><p>GC will scan the module&rsquo;s <code>.data</code> and <code>.bss</code> section to find all objects. An object can be found by <code>findObject</code>, and its GC <code>markBits</code>
can be obtained from <code>mspan</code>. Large objects will be splitted into &ldquo;oblets&rdquo;.</p><h3 id=stack-scanning>Stack Scanning<a hidden class=anchor aria-hidden=true href=#stack-scanning>#</a></h3><ul><li>Code Path: <code>src/runtime/mgcstack.go</code></li></ul><h3 id=gcassistalloc><code>gcAssistAlloc</code><a hidden class=anchor aria-hidden=true href=#gcassistalloc>#</a></h3><p>Goroutines will call <code>gcAssistAlloc</code> to assist the GC.</p><h3 id=memory-barriers>Memory Barriers<a hidden class=anchor aria-hidden=true href=#memory-barriers>#</a></h3><ul><li>Code Path: <code>src/runtime/mbarrier.go</code></li></ul><p>The memory barriers are code snippets insert around a memory operation.
<a href=https://github.com/golang/proposal/blob/master/design/17503-eliminate-rescan.md>Ref</a></p><h4 id=ssa>SSA<a hidden class=anchor aria-hidden=true href=#ssa>#</a></h4><ul><li>Code Path: <code>src/cmd/compile/internal/ssa/writebarrier.go</code>
<code>ssa.writebarrier</code> will rewrite the following instructions of a <code>ssa.Func</code>:</li><li><code>OpStoreWB</code></li><li><code>OpMoveWB</code></li><li><code>OpZeroWB</code></li></ul><h4 id=gc-implementation>GC Implementation<a hidden class=anchor aria-hidden=true href=#gc-implementation>#</a></h4><ul><li>Code Path: <code>src/runtime/mbitmap.go</code></li></ul><h2 id=sweeping>Sweeping<a hidden class=anchor aria-hidden=true href=#sweeping>#</a></h2><ul><li>Code Path: <code>src/runtime/mgcsweep.go</code></li></ul><h3 id=sweepone><code>sweepone</code><a hidden class=anchor aria-hidden=true href=#sweepone>#</a></h3><h2 id=pacing>Pacing<a hidden class=anchor aria-hidden=true href=#pacing>#</a></h2><ul><li>Code Path: <code>src/runtime/mgcpacer.go</code></li></ul><p><code>gcController</code> controls how the GC cycles will run.</p><h3 id=startcycle><code>startCycle</code><a hidden class=anchor aria-hidden=true href=#startcycle>#</a></h3><h2 id=scavenge>Scavenge<a hidden class=anchor aria-hidden=true href=#scavenge>#</a></h2><ul><li>Code Path: <code>src/runtime/mgcscavenge.go</code></li></ul><h2 id=whats-next>What&rsquo;s Next<a hidden class=anchor aria-hidden=true href=#whats-next>#</a></h2><ul><li>Write barriers.</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.kassiansun.com/tags/go/>Go</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.kassiansun.com/>Kassian Sun</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>