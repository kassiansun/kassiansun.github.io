<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Go Runtime Implementations: Slices | Kassian Sun</title><meta name=keywords content="go"><meta name=description content="Code Path: src/runtime/slice.go makeslicecopy makeslicecopy is used for IR patterns like m = OMAKESLICE([]T, x); OCOPY(m, s), IR will rewrite this specific order of code path and replace it with OMAKESLICECOPY. If the elements has no pointer, SSA will generate code to do a mallocgc and memmove. Otherwise, the code will be expanded to makeslicecopy:
Check the length of the slice to copy to. Do mallocgc Do memmove makeslice and `makeslice641 makeslice is used for make(slice, len, cap) statements, if cap is missing, by default it will be the same as len."><meta name=author content><link rel=canonical href=https://kassiansun.github.io/posts/go-source-code-part-15/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://kassiansun.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kassiansun.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kassiansun.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://kassiansun.github.io/apple-touch-icon.png><link rel=mask-icon href=https://kassiansun.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-E9FSQ1R0HV"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E9FSQ1R0HV",{anonymize_ip:!1})}</script><meta property="og:title" content="Go Runtime Implementations: Slices"><meta property="og:description" content="Code Path: src/runtime/slice.go makeslicecopy makeslicecopy is used for IR patterns like m = OMAKESLICE([]T, x); OCOPY(m, s), IR will rewrite this specific order of code path and replace it with OMAKESLICECOPY. If the elements has no pointer, SSA will generate code to do a mallocgc and memmove. Otherwise, the code will be expanded to makeslicecopy:
Check the length of the slice to copy to. Do mallocgc Do memmove makeslice and `makeslice641 makeslice is used for make(slice, len, cap) statements, if cap is missing, by default it will be the same as len."><meta property="og:type" content="article"><meta property="og:url" content="https://kassiansun.github.io/posts/go-source-code-part-15/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-04T09:21:06+08:00"><meta property="article:modified_time" content="2022-11-04T09:21:06+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go Runtime Implementations: Slices"><meta name=twitter:description content="Code Path: src/runtime/slice.go makeslicecopy makeslicecopy is used for IR patterns like m = OMAKESLICE([]T, x); OCOPY(m, s), IR will rewrite this specific order of code path and replace it with OMAKESLICECOPY. If the elements has no pointer, SSA will generate code to do a mallocgc and memmove. Otherwise, the code will be expanded to makeslicecopy:
Check the length of the slice to copy to. Do mallocgc Do memmove makeslice and `makeslice641 makeslice is used for make(slice, len, cap) statements, if cap is missing, by default it will be the same as len."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kassiansun.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Go Runtime Implementations: Slices","item":"https://kassiansun.github.io/posts/go-source-code-part-15/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Go Runtime Implementations: Slices","name":"Go Runtime Implementations: Slices","description":"Code Path: src/runtime/slice.go makeslicecopy makeslicecopy is used for IR patterns like m = OMAKESLICE([]T, x); OCOPY(m, s), IR will rewrite this specific order of code path and replace it with OMAKESLICECOPY. If the elements has no pointer, SSA will generate code to do a mallocgc and memmove. Otherwise, the code will be expanded to makeslicecopy:\nCheck the length of the slice to copy to. Do mallocgc Do memmove makeslice and `makeslice641 makeslice is used for make(slice, len, cap) statements, if cap is missing, by default it will be the same as len.","keywords":["go"],"articleBody":" Code Path: src/runtime/slice.go makeslicecopy makeslicecopy is used for IR patterns like m = OMAKESLICE([]T, x); OCOPY(m, s), IR will rewrite this specific order of code path and replace it with OMAKESLICECOPY. If the elements has no pointer, SSA will generate code to do a mallocgc and memmove. Otherwise, the code will be expanded to makeslicecopy:\nCheck the length of the slice to copy to. Do mallocgc Do memmove makeslice and `makeslice641 makeslice is used for make(slice, len, cap) statements, if cap is missing, by default it will be the same as len.\nTry to allocate the memory of cap length. If len \u003e cap, allocate the memory of len length. If len \u003c 0 or the memory is too large, panic. growslice growslice is used for two appending cases: append(sliceA, sliceB...) and append(sliceA, make(slice, len)). Note that for the first case you only need memmove if len(sliceA) + len(sliceB) \u003c cap(sliceA), and for the second case you only need to expand the len of slice if len(sliceA) + len \u003c cap(sliceA).\nIf the element size is zero, return zerobase Try to double the old cap, if it’s still less than the new len, use the new len as the expected size. If the old cap \u003e 256, allocate 1.25x old cap until it’s larget than the new len. Do mallocgc. Do memmove. slicecopy slicecopy is used in two cases: after growslice to copy the data; used individually as copy(A, B). Note that slicecopy only guarantees memmove, it doesn’t try to allocate the memory.\n","wordCount":"253","inLanguage":"en","datePublished":"2022-11-04T09:21:06+08:00","dateModified":"2022-11-04T09:21:06+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://kassiansun.github.io/posts/go-source-code-part-15/"},"publisher":{"@type":"Organization","name":"Kassian Sun","logo":{"@type":"ImageObject","url":"https://kassiansun.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kassiansun.github.io/ accesskey=h title="Kassian Sun (Alt + H)">Kassian Sun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kassiansun.github.io/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Go Runtime Implementations: Slices</h1><div class=post-meta><span title='2022-11-04 09:21:06 +0800 +0800'>November 4, 2022</span></div></header><div class=post-content><ul><li>Code Path: <code>src/runtime/slice.go</code></li></ul><h2 id=makeslicecopy><code>makeslicecopy</code><a hidden class=anchor aria-hidden=true href=#makeslicecopy>#</a></h2><p><code>makeslicecopy</code> is used for IR patterns like <code>m = OMAKESLICE([]T, x); OCOPY(m, s)</code>, IR will rewrite
this specific order of code path and replace it with <code>OMAKESLICECOPY</code>. If the elements has no pointer,
SSA will generate code to do a <code>mallocgc</code> and <code>memmove</code>. Otherwise, the code will be expanded to <code>makeslicecopy</code>:</p><ul><li>Check the length of the slice to copy to.</li><li>Do <code>mallocgc</code></li><li>Do <code>memmove</code></li></ul><h2 id=makeslice-and-makeslice641><code>makeslice</code> and `makeslice641<a hidden class=anchor aria-hidden=true href=#makeslice-and-makeslice641>#</a></h2><p><code>makeslice</code> is used for <code>make(slice, len, cap)</code> statements, if <code>cap</code> is missing, by default it will be the same as <code>len</code>.</p><ul><li>Try to allocate the memory of <code>cap</code> length.</li><li>If <code>len</code> > <code>cap</code>, allocate the memory of <code>len</code> length.</li><li>If <code>len</code> &lt; 0 or the memory is too large, panic.</li></ul><h2 id=growslice><code>growslice</code><a hidden class=anchor aria-hidden=true href=#growslice>#</a></h2><p><code>growslice</code> is used for two appending cases: <code>append(sliceA, sliceB...)</code> and <code>append(sliceA, make(slice, len))</code>.
Note that for the first case you only need <code>memmove</code> if <code>len(sliceA) + len(sliceB) &lt; cap(sliceA)</code>,
and for the second case you only need to expand the <code>len</code> of slice if <code>len(sliceA) + len &lt; cap(sliceA)</code>.</p><ul><li>If the element size is zero, return <code>zerobase</code></li><li>Try to double the old <code>cap</code>, if it&rsquo;s still less than the new <code>len</code>, use the new <code>len</code> as the expected size.<ul><li>If the old <code>cap</code> > 256, allocate 1.25x old <code>cap</code> until it&rsquo;s larget than the new <code>len</code>.</li></ul></li><li>Do <code>mallocgc</code>.</li><li>Do <code>memmove</code>.</li></ul><h2 id=slicecopy><code>slicecopy</code><a hidden class=anchor aria-hidden=true href=#slicecopy>#</a></h2><p><code>slicecopy</code> is used in two cases: after <code>growslice</code> to copy the data; used individually as <code>copy(A, B)</code>.
Note that <code>slicecopy</code> only guarantees <code>memmove</code>, it doesn&rsquo;t try to allocate the memory.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://kassiansun.github.io/tags/go/>go</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://kassiansun.github.io/>Kassian Sun</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>