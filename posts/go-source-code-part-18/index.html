<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Go Runtime Implementations: Timer Scheduling | Kassian Sun</title>
<meta name=keywords content="go"><meta name=description content="Code Path: src/runtime/time.go time.startTimer (implemented as addtimer) Each p has a timers list. When a user is adding a new timer, it will first try to clean up the timers list, then adds the new timer. Each timers list is a heap sorted by timer.when, and will be updated during add/delete timers.
cleantimers cleantimers only checks the head of the timers list.
Check if it&rsquo;s timerDeleted, delete it from the timers list, and update p&rsquo;s timer0When."><meta name=author content><link rel=canonical href=https://blog.kassiansun.com/posts/go-source-code-part-18/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.kassiansun.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.kassiansun.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.kassiansun.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.kassiansun.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.kassiansun.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.kassiansun.com/posts/go-source-code-part-18/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-E9FSQ1R0HV"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E9FSQ1R0HV")}</script><meta property="og:title" content="Go Runtime Implementations: Timer Scheduling"><meta property="og:description" content="Code Path: src/runtime/time.go time.startTimer (implemented as addtimer) Each p has a timers list. When a user is adding a new timer, it will first try to clean up the timers list, then adds the new timer. Each timers list is a heap sorted by timer.when, and will be updated during add/delete timers.
cleantimers cleantimers only checks the head of the timers list.
Check if it&rsquo;s timerDeleted, delete it from the timers list, and update p&rsquo;s timer0When."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kassiansun.com/posts/go-source-code-part-18/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-07T08:49:37+08:00"><meta property="article:modified_time" content="2022-11-07T08:49:37+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go Runtime Implementations: Timer Scheduling"><meta name=twitter:description content="Code Path: src/runtime/time.go time.startTimer (implemented as addtimer) Each p has a timers list. When a user is adding a new timer, it will first try to clean up the timers list, then adds the new timer. Each timers list is a heap sorted by timer.when, and will be updated during add/delete timers.
cleantimers cleantimers only checks the head of the timers list.
Check if it&rsquo;s timerDeleted, delete it from the timers list, and update p&rsquo;s timer0When."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.kassiansun.com/posts/"},{"@type":"ListItem","position":2,"name":"Go Runtime Implementations: Timer Scheduling","item":"https://blog.kassiansun.com/posts/go-source-code-part-18/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Go Runtime Implementations: Timer Scheduling","name":"Go Runtime Implementations: Timer Scheduling","description":"Code Path: src/runtime/time.go time.startTimer (implemented as addtimer) Each p has a timers list. When a user is adding a new timer, it will first try to clean up the timers list, then adds the new timer. Each timers list is a heap sorted by timer.when, and will be updated during add/delete timers.\ncleantimers cleantimers only checks the head of the timers list.\nCheck if it\u0026rsquo;s timerDeleted, delete it from the timers list, and update p\u0026rsquo;s timer0When.","keywords":["go"],"articleBody":" Code Path: src/runtime/time.go time.startTimer (implemented as addtimer) Each p has a timers list. When a user is adding a new timer, it will first try to clean up the timers list, then adds the new timer. Each timers list is a heap sorted by timer.when, and will be updated during add/delete timers.\ncleantimers cleantimers only checks the head of the timers list.\nCheck if it’s timerDeleted, delete it from the timers list, and update p’s timer0When. Check if it’s timerModifiedEarlier or timerModifiedLater, delete it from the timers list and add it back to put it at the right position in the list. doaddtimer doaddtimer link the time to the p’s timers list, and sift up the heap to put it in the right position.\ntime.stopTimer (implemented as deltimer) deltimer doesn’t delete a timer, the code calling deltimer might be running on a different p from the timer’s p. It will update the timer’s status to timerDeleted and wait for p to clean it up.\ndodeltimer dodeltimer swap the timer at location i with the timer at the last index, and sift down the heap at i-position.\ntimer.modTimer (implemented as modtimer) modtimer updates the when and period of a timer, and returns whether it was modified before it was run.\nTry to update the timer status to timerModifying. If the timer is being modified, wait for it to complete. If the timer was deleted, add the timer back to the current p’s list. Switch the timer to timerWaiting. Call wakeNetPoller to determine whether we should serve the timer. Else, get the p of the timer and only update the nextwhen information, so the correct p will try to pick it up and update it accordingly. resettimer resettimer will reset the timer to fire at a new when value.\nmoveTimers moveTimer happens when a p is destroyed, it will add these timers one by one to the new p’s timers list.\nScheduling of timers Timers will be picked-up during findRunnable.\ncheckTimers Check timer0When and whether we should continue to clean up timers. All calculations are based on fields updated during add/mod/del timers. Do adjustTimers Pick up one timer from the list by runtimer, run it, or return the next timer’s when value as pollNext. adjustTimers Delete the timers with timerDeleted status. Delete the timers that have been modified, and add them back later. If it’s being modified, wait for it to complete. runtimer runtimer will pick up the head of timers list if it’s timerWaiting, and update its status to timerRunning. The actual running is done by runOneTimer:\nIf it has a period value, calculate the new when and sift down the timers list. Else delete it from the timers list. Release the timers lock -\u003e Run the timer function -\u003e Acquire the timers lock. ","wordCount":"463","inLanguage":"en","datePublished":"2022-11-07T08:49:37+08:00","dateModified":"2022-11-07T08:49:37+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.kassiansun.com/posts/go-source-code-part-18/"},"publisher":{"@type":"Organization","name":"Kassian Sun","logo":{"@type":"ImageObject","url":"https://blog.kassiansun.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.kassiansun.com/ accesskey=h title="Kassian Sun (Alt + H)">Kassian Sun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.kassiansun.com/about title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Go Runtime Implementations: Timer Scheduling</h1><div class=post-meta><span title='2022-11-07 08:49:37 +0800 +0800'>November 7, 2022</span></div></header><div class=post-content><ul><li>Code Path: <code>src/runtime/time.go</code></li></ul><h2 id=timestarttimer-implemented-as-addtimer><code>time.startTimer</code> (implemented as <code>addtimer</code>)<a hidden class=anchor aria-hidden=true href=#timestarttimer-implemented-as-addtimer>#</a></h2><p>Each <code>p</code> has a <code>timers</code> list. When a user is adding a new timer, it will first try to clean up the <code>timers</code> list,
then adds the new timer. Each <code>timers</code> list is a heap sorted by <code>timer.when</code>, and will be updated during add/delete timers.</p><h3 id=cleantimers><code>cleantimers</code><a hidden class=anchor aria-hidden=true href=#cleantimers>#</a></h3><p><code>cleantimers</code> only checks the head of the <code>timers</code> list.</p><ul><li>Check if it&rsquo;s <code>timerDeleted</code>, delete it from the <code>timers</code> list, and update <code>p</code>&rsquo;s <code>timer0When</code>.</li><li>Check if it&rsquo;s <code>timerModifiedEarlier</code> or <code>timerModifiedLater</code>, delete it from the <code>timers</code> list and add it back to put it at the right position in the list.</li></ul><h3 id=doaddtimer><code>doaddtimer</code><a hidden class=anchor aria-hidden=true href=#doaddtimer>#</a></h3><p><code>doaddtimer</code> link the time to the <code>p</code>&rsquo;s <code>timers</code> list, and sift up the heap to put it in the right position.</p><h2 id=timestoptimer-implemented-as-deltimer><code>time.stopTimer</code> (implemented as <code>deltimer</code>)<a hidden class=anchor aria-hidden=true href=#timestoptimer-implemented-as-deltimer>#</a></h2><p><code>deltimer</code> doesn&rsquo;t delete a timer, the code calling <code>deltimer</code> might be running on a different <code>p</code> from the timer&rsquo;s <code>p</code>.
It will update the timer&rsquo;s status to <code>timerDeleted</code> and wait for <code>p</code> to clean it up.</p><h3 id=dodeltimer><code>dodeltimer</code><a hidden class=anchor aria-hidden=true href=#dodeltimer>#</a></h3><p><code>dodeltimer</code> swap the timer at location <code>i</code> with the timer at the last index, and sift down the heap at i-position.</p><h2 id=timermodtimer-implemented-as-modtimer><code>timer.modTimer</code> (implemented as <code>modtimer</code>)<a hidden class=anchor aria-hidden=true href=#timermodtimer-implemented-as-modtimer>#</a></h2><p><code>modtimer</code> updates the when and period of a timer, and returns whether it was modified before it was run.</p><ul><li>Try to update the timer status to <code>timerModifying</code>. If the timer is being modified, wait for it to complete.</li><li>If the timer was deleted, add the timer back to the current <code>p</code>&rsquo;s list.<ul><li>Switch the timer to <code>timerWaiting</code>.</li><li>Call <code>wakeNetPoller</code> to determine whether we should serve the timer.</li></ul></li><li>Else, get the <code>p</code> of the timer and only update the <code>nextwhen</code> information, so the correct <code>p</code> will try to pick it up and update it accordingly.</li></ul><h3 id=resettimer><code>resettimer</code><a hidden class=anchor aria-hidden=true href=#resettimer>#</a></h3><p><code>resettimer</code> will reset the timer to fire at a new <code>when</code> value.</p><h3 id=movetimers><code>moveTimers</code><a hidden class=anchor aria-hidden=true href=#movetimers>#</a></h3><p><code>moveTimer</code> happens when a <code>p</code> is destroyed, it will add these timers one by one to the new <code>p</code>&rsquo;s timers list.</p><h2 id=scheduling-of-timers>Scheduling of timers<a hidden class=anchor aria-hidden=true href=#scheduling-of-timers>#</a></h2><p>Timers will be picked-up during <code>findRunnable</code>.</p><h3 id=checktimers><code>checkTimers</code><a hidden class=anchor aria-hidden=true href=#checktimers>#</a></h3><ul><li>Check <code>timer0When</code> and whether we should continue to clean up timers. All calculations are based on fields updated during add/mod/del timers.</li><li>Do <code>adjustTimers</code></li><li>Pick up one timer from the list by <code>runtimer</code>, run it, or return the next timer&rsquo;s <code>when</code> value as <code>pollNext</code>.</li></ul><h3 id=adjusttimers><code>adjustTimers</code><a hidden class=anchor aria-hidden=true href=#adjusttimers>#</a></h3><ul><li>Delete the timers with <code>timerDeleted</code> status.</li><li>Delete the timers that have been modified, and add them back later.</li><li>If it&rsquo;s being modified, wait for it to complete.</li></ul><h3 id=runtimer><code>runtimer</code><a hidden class=anchor aria-hidden=true href=#runtimer>#</a></h3><p><code>runtimer</code> will pick up the head of <code>timers</code> list if it&rsquo;s <code>timerWaiting</code>, and update its status to <code>timerRunning</code>.
The actual running is done by <code>runOneTimer</code>:</p><ul><li>If it has a period value, calculate the new when and sift down the timers list.</li><li>Else delete it from the timers list.</li><li>Release the timers lock -> Run the timer function -> Acquire the timers lock.</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.kassiansun.com/tags/go/>Go</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.kassiansun.com/>Kassian Sun</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>