<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Go | Kassian Sun</title>
<meta name=keywords content><meta name=description content><meta name=author content><link rel=canonical href=https://blog.kassiansun.com/tags/go/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.kassiansun.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.kassiansun.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.kassiansun.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.kassiansun.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.kassiansun.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://blog.kassiansun.com/tags/go/index.xml><link rel=alternate hreflang=en href=https://blog.kassiansun.com/tags/go/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-0NC5Q6H2ZC"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0NC5Q6H2ZC")}</script><meta property="og:title" content="Go"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://blog.kassiansun.com/tags/go/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go"><meta name=twitter:description content></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.kassiansun.com/ accesskey=h title="Kassian Sun (Alt + H)">Kassian Sun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.kassiansun.com/about title=About><span>About</span></a></li></ul></nav></header><main class=main><header class=page-header><h1>Go</h1></header><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Go Runtime Implementations: Map</h2></header><div class=entry-content><p>Code Path: src/runtime/map.go makemap Each hmap has a hash0 as seed hash. When the compiler generates the typing information for a map, the hasher function will be calculated with genhash function (code path: src/cmd/compile/internal/reflectdata/alg.go).
If the map is not escaped, the hmap will be allocated by the compiler on the stack.
Then makemap will allocate an array of bucket, the type of bucket is generated at compiling stage by MapBucketType (code path: src/cmd/compile/internal/reflectdata/reflect.go).
...</p></div><footer class=entry-footer><span title='2022-11-23 16:51:25 +0800 +0800'>November 23, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Map" href=https://blog.kassiansun.com/posts/go-source-code-part-19/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Go Runtime Implementations: Timer Scheduling</h2></header><div class=entry-content><p>Code Path: src/runtime/time.go time.startTimer (implemented as addtimer) Each p has a timers list. When a user is adding a new timer, it will first try to clean up the timers list, then adds the new timer. Each timers list is a heap sorted by timer.when, and will be updated during add/delete timers.
cleantimers cleantimers only checks the head of the timers list.
Check if it’s timerDeleted, delete it from the timers list, and update p’s timer0When. Check if it’s timerModifiedEarlier or timerModifiedLater, delete it from the timers list and add it back to put it at the right position in the list. doaddtimer doaddtimer link the time to the p’s timers list, and sift up the heap to put it in the right position.
...</p></div><footer class=entry-footer><span title='2022-11-07 08:49:37 +0800 +0800'>November 7, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Timer Scheduling" href=https://blog.kassiansun.com/posts/go-source-code-part-18/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Go Runtime Implementations: Network Polling</h2></header><div class=entry-content><p>Code Path: src/runtime/netpoll.go Network polling is platform-dependent, the following is of BSD family operating systems (based on kqueue).
netpollinit Initialize a kqueue descriptor, and set CLOSEXEC flag on it. Initialize a non-blocking pipe, and use the reader/writer for netpollBreak. netpollBreak will try to write to the pipe and interrupt the kevent. netpoll netpoll is used to check the connections and return a list of g ready to run. It can block for delay ns at most. The delay parameter will be passed to kevent syscall.
...</p></div><footer class=entry-footer><span title='2022-11-05 08:56:11 +0800 +0800'>November 5, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Network Polling" href=https://blog.kassiansun.com/posts/go-source-code-part-17/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Go Runtime Implementations: Select</h2></header><div class=entry-content><p>Code Path: src/runtime/select.go IR stage IR will walk a select statement and generate the code accordingly:
If there’s no case, replace the select statement with runtime.block, the current goroutine will be blocked forever. If there’s only one case, extract the send or receive operation from the case statement. Otherwise, convert case values to addresses. If there’s only one case with one default, replace it with non-block calls selectnbsend or selectnbrecv. Generate a select statement with the list of send and recv cases, and run selectgo on it. Run the case or default based on the returned index of selectgo. selectgo selectgo takes two major arguments: a list of scase and a list of the orders of recv/send. It returns the pos of case to execute.
...</p></div><footer class=entry-footer><span title='2022-11-04 14:14:30 +0800 +0800'>November 4, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Select" href=https://blog.kassiansun.com/posts/go-source-code-part-16/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Go Runtime Implementations: Slices</h2></header><div class=entry-content><p>Code Path: src/runtime/slice.go makeslicecopy makeslicecopy is used for IR patterns like m = OMAKESLICE([]T, x); OCOPY(m, s), IR will rewrite this specific order of code path and replace it with OMAKESLICECOPY. If the elements has no pointer, SSA will generate code to do a mallocgc and memmove. Otherwise, the code will be expanded to makeslicecopy:
Check the length of the slice to copy to. Do mallocgc Do memmove makeslice and `makeslice641 makeslice is used for make(slice, len, cap) statements, if cap is missing, by default it will be the same as len.
...</p></div><footer class=entry-footer><span title='2022-11-04 09:21:06 +0800 +0800'>November 4, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Slices" href=https://blog.kassiansun.com/posts/go-source-code-part-15/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Go Runtime Implementations: Interfaces</h2></header><div class=entry-content><p>Static Definition and Initialization Code Path: src/runtime/iface.go In proc.go, itabsinit will init the itabTable with the current activeModules information. The itabsinit function will read the itablinks from each module and add them to the global hash table.
During the runtime, the getitab function will also build more items dynamically and fill the hash table accordingly.
itablinks was produced for each module during the linking stage, and contains an array of itab. itab is generated by writeITab function (code path: cmd/compile/internal/reflectdata/reflect.go), used to store the type link between a concrete type (_type field) implementing an interface (inter field). If _type doesn’t implement inter, fun will be empty; else it will save the methods of _type implementing inter (not all methods of _type).
...</p></div><footer class=entry-footer><span title='2022-10-27 10:16:17 +0800 +0800'>October 27, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Interfaces" href=https://blog.kassiansun.com/posts/go-source-code-part-14/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Go Runtime Implementations: Typing System</h2></header><div class=entry-content><p>Compiling Code Path: src/cmd/compile/internal/ir/expr.go During the IR stage, each expression will get type info, it’s defined as miniExpr and can be assigned a types.Type value.
Static Typing: types2 Code Path: src/cmd/compile/internal/types2 types and `types2 Conversion Code Path: src/cmd/compile/internal/noder/types.go Currently, both packages are in use, but much logic is being migrated to types2 package. types2 package was introduced as part of go generic features and has a better code structure than the old types package.
...</p></div><footer class=entry-footer><span title='2022-10-25 17:59:51 +0800 +0800'>October 25, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Typing System" href=https://blog.kassiansun.com/posts/go-source-code-part-13/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Go Runtime Implementations: Garbage Collection</h2></header><div class=entry-content><p>Ref Garbage Collector Code Path: src/runtime/mgc.go gcinit gcinit runs after almost everything set up in schedinit.
Set sweepDrainedMask Initialize gcController with GOGC (for GC percentage control) and GOMEMLIMIT (for memory limits). Initialize work semaphores. gcenable gcenable happens in the main goroutine, right after runtime_inittask.
Start bgsweep Start bgscavenge GC GC runs a full garbage collection. Each run will finish the current GC cycle: sweep termination, mark, mark termination, and sweep. Then it will start a new GC cycle. Note that GC cycles can move forward to more than N+1.
...</p></div><footer class=entry-footer><span title='2022-10-18 14:17:39 +0800 +0800'>October 18, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Garbage Collection" href=https://blog.kassiansun.com/posts/go-source-code-part-11/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Go Runtime Implementations: Stack and Memory Management</h2></header><div class=entry-content><p>Stack Management Code Path: src/runtime/stack.go Stack pools are initialized before mheap_, because we don’t allocate any memory during this stage. Right after the stack pools initialized, the mheap_ will be initialized so later stack allocation is possible.
stackpool stackpool is managed by the “order” (based on the ratio of stack size and _FixedStack) of the stack, each order of stack has its own stack pool. In stackinit, the stack pool will be initialized right after moduledataverify.
...</p></div><footer class=entry-footer><span title='2022-10-16 15:48:13 +0800 +0800'>October 16, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Stack and Memory Management" href=https://blog.kassiansun.com/posts/go-source-code-part-10/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Go Runtime Implementations: Scheduling</h2></header><div class=entry-content><p>Code Path: src/runtime/proc.go Start-Up Process of a Go program. Take src/runtime/asm_arm.s as an example:
Take the address of g0 and m0. Set up m.g0 and g.m. Create istack. Do runtime check. Save argc and argv. Call runtime.osinit. Call runtime.schedinit. Call runtime.newproc for the main function. call runtime.mstart to start the M. runtime.osinit Take src/runtime/os_linux.go as an example:
Get the number of processors. This is done by making a syscall SYS_sched_getaffinity. Get the huge page size. Run osArchInit. &lt;- Seems not used. runtime.schedinit Initialize all the locks. Set up the g.racectx. Stop the world. moduledataverify. Defined in src/runtime/symtab.go, it will check moduledata’s binary info. stackinit. Defined in src/runtime/stack.go, it will setup the global stack pool, all stacks will be allocated by it. mallocinit. Defined in src/runtime/malloc.go, it will initialize the memory allocator used by Go. cpuinit. Set up the internal/cpu information. alginit. Defined in src/runtime/alg.go, set up the CPU instructions that will be used by some internal algorithms, depending on cpuinit. fastrandinit. Initialize the g0.m with mcommoninit. modulesinit. Defined in src/runtime/symtab.go, initialize the dynamic loaded modules. typelinksinit. Defined in src/runtime/type.go, initialized the dynamic-loaded module type informations. itabsinit. Defined in src/runtime/iface.go, update itabTable with the dynamic-loaded modules. stkobjinit. Defined in src/runtime/stkframe.go, this will set up methodValueCallFrameObjs, used by later GC module. Save the signal mask as initSigMask. Parse argv. Defined in src/runtime/runtime1.go. Parse environment variables. parsedebugvars. Defined in src/runtime/runtime1.go. gcinit. Set up the number of processors, and trim it accordingly with procresize: Grow allp as necessary. Initialize all the p’s of allp. Release old p’s. Track the idle and runnable p, and return the runnable p’s. There should be zero runnable p, since this is only a bootstrap process. Start the world. runtime.mstart mstart0 set up the stack info, then calls runtime.mstart1 to allocate the m:
...</p></div><footer class=entry-footer><span title='2022-10-14 18:31:51 +0800 +0800'>October 14, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Scheduling" href=https://blog.kassiansun.com/posts/go-source-code-part-9/></a></article><footer class=page-footer><nav class=pagination><a class=next href=https://blog.kassiansun.com/tags/go/page/2/>Next&nbsp;&nbsp;»</a></nav></footer></main><footer class=footer><span>&copy; 2024 <a href=https://blog.kassiansun.com/>Kassian Sun</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>