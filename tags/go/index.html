<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>go | Kassian Sun</title><meta name=keywords content><meta name=description content><meta name=author content><link rel=canonical href=https://kassiansun.github.io/tags/go/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><link rel=icon href=https://kassiansun.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kassiansun.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kassiansun.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://kassiansun.github.io/apple-touch-icon.png><link rel=mask-icon href=https://kassiansun.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://kassiansun.github.io/tags/go/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-E9FSQ1R0HV"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E9FSQ1R0HV",{anonymize_ip:!1})}</script><meta property="og:title" content="go"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://kassiansun.github.io/tags/go/"><meta name=twitter:card content="summary"><meta name=twitter:title content="go"><meta name=twitter:description content></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kassiansun.github.io/ accesskey=h title="Kassian Sun (Alt + H)">Kassian Sun</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kassiansun.github.io/about title=About><span>About</span></a></li></ul></nav></header><main class=main><header class=page-header><h1>go</h1></header><article class="post-entry tag-entry"><header class=entry-header><h2>Go Runtime Implementations: Garbage Collection</h2></header><div class=entry-content><p>Ref Garbage Collector Code Path: src/runtime/mgc.go gcinit gcinit runs after almost everything set up in schedinit.
Set sweepDrainedMask Initialize gcController with GOGC (for GC percentage control) and GOMEMLIMIT (for memory limits). Initialize work semaphores. gcenable gcenable happens in the main goroutine, right after runtime_inittask.
Start bgsweep Start bgscavenge GC GC runs a full garbage collection. Each run will finish the current GC cycle: sweep termination, mark, mark termination, and sweep....</p></div><footer class=entry-footer><span title='2022-10-18 14:17:39 +0800 +0800'>October 18, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Garbage Collection" href=https://kassiansun.github.io/posts/go-source-code-part-11/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Go Runtime Implementations: Stack and Memory Management</h2></header><div class=entry-content><p>Stack Management Code Path: src/runtime/stack.go Stack pools are initialized before mheap_, because we don’t allocate any memory during this stage. Right after the stack pools initialized, the mheap_ will be initialized so later stack allocation is possible.
stackpool stackpool is managed by the “order” (based on the ratio of stack size and _FixedStack) of the stack, each order of stack has its own stack pool. In stackinit, the stack pool will be initialized right after moduledataverify....</p></div><footer class=entry-footer><span title='2022-10-16 15:48:13 +0800 +0800'>October 16, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Stack and Memory Management" href=https://kassiansun.github.io/posts/go-source-code-part-10/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Go Runtime Implementations: Scheduling</h2></header><div class=entry-content><p>Code Path: src/runtime/proc.go Start-Up Process of a Go program. Take src/runtime/asm_arm.s as an example:
Take the address of g0 and m0. Set up m.g0 and g.m. Create istack. Do runtime check. Save argc and argv. Call runtime.osinit. Call runtime.schedinit. Call runtime.newproc for the main function. call runtime.mstart to start the M. runtime.osinit Take src/runtime/os_linux.go as an example:
Get the number of processors. This is done by making a syscall SYS_sched_getaffinity....</p></div><footer class=entry-footer><span title='2022-10-14 18:31:51 +0800 +0800'>October 14, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Scheduling" href=https://kassiansun.github.io/posts/go-source-code-part-9/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Go Runtime Implementations: Goroutines</h2></header><div class=entry-content><p>Preface Code path: src/runtime/proc.go Data structures are defined under src/runtime/runtime2.go. Concepts Copied from source code:
// G - goroutine. // M - worker thread, or machine. // P - processor, a resource that is required to execute Go code. // M must have an associated P to execute Go code, however it can be // blocked or in a syscall w/o an associated P. main Set up stack size. Fork a new m and run the sysmon function, except the wasm platform....</p></div><footer class=entry-footer><span title='2022-10-12 14:42:48 +0800 +0800'>October 12, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Goroutines" href=https://kassiansun.github.io/posts/go-source-code-part-8/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Go Runtime Implementations: Channel</h2></header><div class=entry-content><p>Path: src/runtime/chan.go Compilation When you make a chan with make function, the compiler will expand the expression to the makechan implementation. The actual expansion happens at cmd/compile/internal/walk/expr.go. The runtime will determine whether to use makechan or makechan64.
Type Definitions type _type _type is used as the internal representation of a go type. The same structure is defined multiple times across the go runtime. _type stores the following fields:
type chantype makechan only uses chantype....</p></div><footer class=entry-footer><span title='2022-09-29 11:24:26 +0800 +0800'>September 29, 2022</span></footer><a class=entry-link aria-label="post link to Go Runtime Implementations: Channel" href=https://kassiansun.github.io/posts/go-source-code-part-7/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Travesal Through The Go Compiler, Part 6</h2></header><div class=entry-content><p>ssagen.Compile Build SSA for the ir.Func (buildssa) Check ssaDump and set the dump flag. Initialize ssagen.state. Push the line number or the parent’s line number (if it’s missing) to the stack. Set up ssagen.state flags from ir.Func information. Set up an empty ssagen.ssafn with ir.Func and ABI information. Allocate the starting block for the current ssa.Func. Check open-coded defers. &lt;- What’s this? Do ABIAnalyze, get the abi.ABIParamResultInfo of function in/out parameters....</p></div><footer class=entry-footer><span title='2022-09-20 10:39:15 +0800 +0800'>September 20, 2022</span></footer><a class=entry-link aria-label="post link to Travesal Through The Go Compiler, Part 6" href=https://kassiansun.github.io/posts/go-source-code-part-6/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Travesal Through The Go Compiler, Part 5</h2></header><div class=entry-content><p>irgen.generate Check each file’s pragma list and DeclList. Generate ir.Decl for type declarations. Generate ir.Decl for other declarations. Process later functions, this step is for the same purpose as type check. Type-check CallExpr again. Check missing function bodies. Build generic instantiations. It scans calls and generated needed methods. Remove all generic Decl’s. After irgen.generate, g.target.Decls will be the final Decl’s to generate.
enqueueFunc and compileFunctions This step is the compile step of cmd/compile, it happens after type checking and IR generation....</p></div><footer class=entry-footer><span title='2022-09-19 10:54:34 +0800 +0800'>September 19, 2022</span></footer><a class=entry-link aria-label="post link to Travesal Through The Go Compiler, Part 5" href=https://kassiansun.github.io/posts/go-source-code-part-5/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Travesal Through The Go Compiler, Part 4</h2></header><div class=entry-content><p>noder.LoadPackage Parsing noder.LoadPackage will call syntax.Parse to generate the syntax tree of all package files.
Initialize a compile/internal/syntax.scanner Advance scanner to the next token. Start parsing. Check the package declaration first, and take the package name from the parsed pragma. Note that the parser is expecting a ; token, but this is automatically generated at the scanner, so users don’t have to write the ;. And parsing errors will not always abort the parser loop....</p></div><footer class=entry-footer><span title='2022-09-18 14:09:58 +0800 +0800'>September 18, 2022</span></footer><a class=entry-link aria-label="post link to Travesal Through The Go Compiler, Part 4" href=https://kassiansun.github.io/posts/go-source-code-part-4/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Travesal Through The Go Compiler, Part 3</h2></header><div class=entry-content><p>BuildToolchain BuildToolchain is initialized as noToolchain{} by default, then it’s set dynamically to gccgo or gc. Both implementations are wrappers around the binary toolchains installed on the machine. For gc, the delegations are as follows:
BuildToolchain.gc - base.Tool("compile") BuildToolchain.cc - base.Tool("cgo"). Actually cgo has been executed before the compile and cfiles has been cleared, so BuildToolchain.cc should never be called and it always returns an error. BuildToolchain.asm - base.Tool("asm") BuildToolchain.pack - base....</p></div><footer class=entry-footer><span title='2022-09-17 09:29:52 +0800 +0800'>September 17, 2022</span></footer><a class=entry-link aria-label="post link to Travesal Through The Go Compiler, Part 3" href=https://kassiansun.github.io/posts/go-source-code-part-3/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Travesal Through The Go Compiler, Part 2</h2></header><div class=entry-content><p>Builder.build Builder.build generate an archive for a single package.
Builder.build gets building information from two sources: internal/cfg package. It contains some global variables saving build flags. load.Package. It contains information for the current building package. Builder.build will build a need flag, finish the step and uncheck the finished bits one by one. Set up caching information by action, its package, and package’s target. Set up objects output directory. Setup cgo cache & vet cache....</p></div><footer class=entry-footer><span title='2022-09-16 15:16:23 +0800 +0800'>September 16, 2022</span></footer><a class=entry-link aria-label="post link to Travesal Through The Go Compiler, Part 2" href=https://kassiansun.github.io/posts/go-source-code-part-2/></a></article><footer class=page-footer><nav class=pagination><a class=next href=https://kassiansun.github.io/tags/go/page/2/>Next&nbsp;&nbsp;»</a></nav></footer></main><footer class=footer><span>&copy; 2022 <a href=https://kassiansun.github.io/>Kassian Sun</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>